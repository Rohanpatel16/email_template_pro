<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Email Template Previewer</title>
    <link rel="stylesheet" href="shared-styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="shared-utils.js"></script>
    <script type="importmap">
        {
            "imports": {
                "@google/generative-ai": "https://esm.sh/@google/generative-ai@0.21.0"
            }
        }
    </script>
    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";
        window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom Color Palette */
        :root {
            --color-black: #080708;
            --color-carrot-orange: #e89005;
            --color-poppy: #df2935;
            --color-blue-violet: #8338ec;
            --color-platinum: #e6e8e6;
            --color-platinum-dark: #d0d2d0;
            --color-white: #ffffff;
            --color-light-bg: #f8f9fa;
            
            /* Semantic colors */
            --color-primary: var(--color-blue-violet);
            --color-success: var(--color-carrot-orange);
            --color-warning: var(--color-poppy);
            --color-text: var(--color-black);
            --color-text-muted: #4a4a4a;
            --color-border: var(--color-platinum);
            --color-bg: var(--color-light-bg);
            
            /* Transitions */
            --transition-smooth: all 0.3s ease-in-out;
            --transition-fast: all 0.15s ease-in-out;
        }
        
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, var(--color-platinum) 100%);
            padding-bottom: 70px; /* Space for status bar */
            color: var(--color-text);
        }
        
        /* Mobile responsiveness improvements */
        @media (max-width: 768px) {
            .container {
                padding: 1rem !important;
            }
            
            .grid-cols-1.lg\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }
            
            .toolbar {
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            
            .toolbar-btn, .toolbar-select {
                padding: 0.5rem !important;
                font-size: 0.875rem !important;
            }
            
            #email-preview {
                min-height: 200px !important;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-2 {
                grid-template-columns: 1fr !important;
            }
            
            .fixed.bottom-0 {
                font-size: 0.75rem !important;
                padding: 0.5rem !important;
            }
        }
        
        @media (max-width: 640px) {
            .p-6 {
                padding: 1rem !important;
            }
            
            .p-8 {
                padding: 1rem !important;
            }
            
            .text-xl {
                font-size: 1.125rem !important;
            }
            
            .space-x-4 > * + * {
                margin-left: 0.5rem !important;
            }
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: var(--color-platinum);
            border-radius: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--color-blue-violet);
            border-radius: 5px;
            transition: var(--transition-fast);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--color-carrot-orange);
        }
        #email-preview:focus {
            outline: 2px solid var(--color-blue-violet);
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(131, 56, 236, 0.1);
        }
        .toolbar-btn {
            background: var(--color-platinum);
            color: var(--color-text);
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: var(--transition-fast);
            border: 1px solid transparent;
        }
        .toolbar-btn:hover:not(:disabled) {
            background: var(--color-blue-violet);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(131, 56, 236, 0.3);
        }
        .toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .toolbar-select {
            background: var(--color-platinum);
            color: var(--color-text);
            font-weight: 500;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            transition: var(--transition-fast);
            appearance: none;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .toolbar-select:hover {
            background: var(--color-platinum-dark);
            border-color: var(--color-blue-violet);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid var(--color-platinum);
            border-radius: 0.75rem;
            transition: var(--transition-fast);
            color: var(--color-text);
        }
        .input-field:focus {
            outline: none;
            border-color: var(--color-blue-violet);
            box-shadow: 0 0 0 4px rgba(131, 56, 236, 0.1);
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }
        
        /* --- STYLES FOR SPAM CHECKER INTEGRATION --- */
        .hwt-container {
            position: relative;
            display: inline-block;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--color-black);
            border-radius: 0.75rem;
        }
        .hwt-backdrop {
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            overflow: auto;
            pointer-events: none;
        }
        .hwt-highlights {
            white-space: pre-wrap;
            word-wrap: break-word;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }
        .hwt-content {
            display: block;
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            font: inherit;
            line-height: inherit;
            letter-spacing: inherit;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .hwt-input {
            display: block;
            position: relative;
            margin: 0;
            color: var(--color-platinum);
            background-color: transparent;
            resize: none;
            width: 100%;
            height: 100%;
            font-size: 0.875rem;
            line-height: 1.6;
        }
        mark {
            padding: 0 2px;
            border-radius: 4px;
            color: transparent;
            -webkit-text-fill-color: transparent;
        }
        mark.spam-category-urgency { 
            background-color: rgba(223, 41, 53, 0.5);
            border-bottom: 2px solid var(--color-poppy);
        }
        mark.spam-category-shady { 
            background-color: rgba(131, 56, 236, 0.3);
            border-bottom: 2px solid var(--color-blue-violet);
        }
        mark.spam-category-money { 
            background-color: rgba(232, 144, 5, 0.4);
            border-bottom: 2px solid var(--color-carrot-orange);
        }
        mark.spam-category-overpromise { 
            background-color: rgba(232, 144, 5, 0.3);
            border-bottom: 2px solid var(--color-carrot-orange);
        }
        mark.spam-category-unnatural { 
            background-color: rgba(131, 56, 236, 0.2);
            border-bottom: 2px solid var(--color-blue-violet);
        }
        /* Make preview text inside marks visible */
        #email-preview mark { color: inherit; -webkit-text-fill-color: inherit; }
        /* Hide highlights in the left source editor overlay */
        .hwt-backdrop { display: none !important; }

        #spam-checker--aside table { 
            width: 100%;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }
        #spam-checker--aside td { 
            padding: 0.5rem 0;
            color: var(--color-text-muted);
        }
        #spam-checker--aside td:last-child { 
            font-weight: 600;
            color: var(--color-text);
            text-align: right;
        }
        #spam-checker--aside ul { 
            list-style: none;
            margin: 0.5rem 0;
            font-size: 0.875rem;
        }
        #spam-checker--aside li { 
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text-muted);
            margin: 0.25rem 0;
        }
        #spam-checker--aside li span { 
            font-weight: 600;
            color: var(--color-text);
        }
        #spam-checker--aside .text-great { 
            color: var(--color-carrot-orange);
            font-weight: 700;
        }
        #spam-checker--aside .text-okay { 
            color: var(--color-blue-violet);
            font-weight: 700;
        }
        #spam-checker--aside .text-poor { 
            color: var(--color-poppy);
            font-weight: 700;
        }
        
        /* AI Response Styling */
        .ai-action-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.5rem;
            transition: var(--transition-fast);
            border: none;
            cursor: pointer;
        }
        .ai-btn-copy {
            background: var(--color-platinum);
            color: var(--color-text);
        }
        .ai-btn-copy:hover {
            background: var(--color-platinum-dark);
            transform: translateY(-1px);
        }
        .ai-btn-apply {
            background: var(--color-carrot-orange);
            color: white;
        }
        .ai-btn-apply:hover {
            background: #d17f04;
            box-shadow: 0 4px 12px rgba(232, 144, 5, 0.4);
            transform: translateY(-1px);
        }
        .ai-btn-use {
            background: var(--color-blue-violet);
            color: white;
        }
        .ai-btn-use:hover {
            background: #6d2bc5;
            box-shadow: 0 4px 12px rgba(131, 56, 236, 0.4);
            transform: translateY(-1px);
        }
        .ai-btn-copy-small {
            background: var(--color-platinum);
            color: var(--color-text-muted);
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        .ai-btn-copy-small:hover {
            background: var(--color-platinum-dark);
        }
        
        .ai-content-card {
            background: white;
            border: 2px solid var(--color-platinum);
            border-radius: 0.75rem;
            padding: 1.25rem;
            font-size: 0.875rem;
            color: var(--color-text);
            line-height: 1.7;
            transition: var(--transition-fast);
        }
        .ai-content-card:hover {
            border-color: var(--color-blue-violet);
            box-shadow: 0 4px 16px rgba(131, 56, 236, 0.1);
        }
        
        .ai-subject-card {
            background: white;
            border: 2px solid var(--color-platinum);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: var(--transition-fast);
        }
        .ai-subject-card:hover {
            border-color: var(--color-carrot-orange);
            box-shadow: 0 4px 16px rgba(232, 144, 5, 0.15);
            transform: translateY(-2px);
        }
        .ai-subject-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        .ai-subject-number {
            font-weight: 700;
            color: var(--color-blue-violet);
            margin-right: 0.5rem;
            flex-shrink: 0;
        }
        .ai-subject-text {
            flex-grow: 1;
            color: var(--color-text);
            font-weight: 600;
        }
        .ai-subject-meta {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            flex-shrink: 0;
            margin-left: 0.5rem;
        }
        .ai-subject-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .ai-spam-indicator {
            margin-left: 0.25rem;
            font-size: 0.75rem;
        }
        
        .ai-suggestions-content {
            @apply space-y-3;
        }
        .ai-suggestions-content h4 {
            @apply text-sm font-semibold text-gray-800 mt-3 mb-2 flex items-center;
        }
        .ai-suggestions-content ul {
            @apply ml-4 space-y-1;
        }
        .ai-suggestions-content li {
            @apply text-sm text-gray-700;
        }
        
        .ai-response-optimize .ai-content-card {
            border-color: var(--color-carrot-orange);
            background: linear-gradient(135deg, #fff9f0 0%, white 100%);
        }
        .ai-response-suggestions .ai-content-card {
            border-color: var(--color-blue-violet);
            background: linear-gradient(135deg, #f5f0ff 0%, white 100%);
        }
        .ai-response-tone .ai-content-card {
            border-color: var(--color-blue-violet);
            background: linear-gradient(135deg, #f5f0ff 0%, white 100%);
        }
        .ai-response-subjects .ai-subject-card {
            border-color: var(--color-carrot-orange);
            background: linear-gradient(135deg, #fff9f0 0%, white 100%);
        }
        
        .ai-suggestions-content ul {
            @apply list-disc ml-6 space-y-2;
        }
        .ai-suggestions-content li {
            @apply text-sm text-gray-700 leading-relaxed;
        }
        .ai-suggestions-content strong {
            @apply font-semibold text-gray-900;
        }
        .suggestion-section {
            @apply bg-white border border-blue-100 rounded-lg p-4;
        }
        .ai-content-card ul {
            @apply list-disc ml-6 space-y-1;
        }
        .ai-content-card ol {
            @apply list-decimal ml-6 space-y-1;
        }
        
        /* Animation keyframes */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }
        
        /* Apply animations */
        .container > div {
            animation: fadeIn 0.5s ease-out;
        }
        
        /* Enhanced button focus states */
        button:focus-visible {
            outline: 2px solid var(--color-blue-violet);
            outline-offset: 2px;
        }
        
        /* Smooth link hover effects */
        a:hover {
            opacity: 0.8;
        }
        
        /* Enhanced card shadows on hover */
        .bg-white:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
        }
        
        /* Loading spinner */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        
        /* Gradient text animation */
        @keyframes gradient-shift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        /* Enhanced placeholder styling */
        ::placeholder {
            color: var(--color-text-muted);
            opacity: 0.6;
        }
        
        /* Better selection styling */
        ::selection {
            background: var(--color-blue-violet);
            color: white;
        }
        
        /* Smooth page transitions */
        html {
            scroll-behavior: smooth;
        }
        
        /* Auto-style links in email preview */
        #email-preview a {
            color: #0400ff !important;
            text-decoration: underline !important;
        }
        
        /* Tone preset buttons */
        .tone-preset:hover {
            background: var(--color-carrot-orange) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(232, 144, 5, 0.3);
        }
        
        /* Template list items */
        .template-item {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: 2px solid var(--color-platinum);
            background: white;
            transition: var(--transition-fast);
            cursor: pointer;
        }
        .template-item:hover {
            border-color: var(--color-blue-violet);
            background: var(--color-light-bg);
            transform: translateX(4px);
        }
    </style>
</head>
<body class="text-slate-800">

    <!-- Modern Header -->
    <div class="sticky top-0 z-50 backdrop-blur-lg bg-white/80 border-b-2 shadow-sm" style="border-color: var(--color-platinum);">
        <div class="container mx-auto px-4 md:px-8 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background: linear-gradient(135deg, var(--color-blue-violet) 0%, var(--color-carrot-orange) 100%);">
                        <i class="fas fa-envelope text-white text-lg"></i>
                    </div>
                    <h1 class="text-2xl font-bold" style="background: linear-gradient(135deg, var(--color-blue-violet), var(--color-carrot-orange)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; color: transparent;">
                        Email Template Editor
                    </h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="settings-btn" class="px-4 py-2 rounded-lg font-medium transition-all" style="background: var(--color-platinum); color: var(--color-text);">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Left Column: Input & Controls -->
            <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col space-y-6" style="border: 2px solid var(--color-platinum);">
                <div>
                    <h2 class="text-xl font-semibold mb-4 text-slate-900">Define Template Variables</h2>
                    <div id="variables-container" class="space-y-3">
                        <!-- Dynamic variables will be injected here -->
                    </div>
                    <div class="flex flex-wrap gap-2 mt-3">
                        <button id="add-variable-btn" class="text-sm font-semibold transition-all px-3 py-1.5 rounded-lg" style="color: var(--color-blue-violet);">
                            <i class="fas fa-plus-circle mr-1"></i> Add Variable
                        </button>
                        <button id="save-template-btn" class="text-sm font-semibold transition-all px-3 py-1.5 rounded-lg" style="color: var(--color-carrot-orange);">
                            <i class="fas fa-save mr-1"></i> Save Template
                        </button>
                        <button id="load-template-btn" class="text-sm font-semibold transition-all px-3 py-1.5 rounded-lg" style="color: var(--color-blue-violet);">
                            <i class="fas fa-folder-open mr-1"></i> Load Template
                        </button>
                        <a href="templates.html" id="manage-templates-btn" class="text-sm font-semibold transition-all px-3 py-1.5 rounded-lg" style="color: var(--color-blue-violet);">
                            <i class="fas fa-database mr-1"></i> Templates Library
                        </a>
                        <button id="clear-all-btn" class="text-sm font-semibold transition-all px-3 py-1.5 rounded-lg" style="color: var(--color-poppy);">
                            <i class="fas fa-trash mr-1"></i> Clear All
                        </button>
                    </div>
                </div>

                <div class="flex flex-col flex-grow">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--color-text);">Edit Email HTML & Check Spam Score</h2>
                    <div class="relative flex-grow h-full rounded-xl border-2 focus-within:ring-2 transition-all" style="background: var(--color-black); border-color: var(--color-platinum);">
                        <textarea id="spam-checker--textarea" class="w-full h-full p-4 font-mono text-sm custom-scrollbar" style="min-height: 400px; background: transparent; color: var(--color-platinum);"></textarea>
                        <button id="copy-html-btn" class="absolute top-3 right-3 text-white text-xs font-semibold py-2 px-3 rounded-lg transition-all hover:transform hover:-translate-y-0.5" style="background: var(--color-blue-violet);">
                            <i class="fas fa-copy mr-1"></i>Copy HTML
                        </button>
                    </div>
                    <div id="spam-checker--aside" class="mt-4 p-4 rounded-xl border-2" style="background: white; border-color: var(--color-platinum);">
                        <i style="color: var(--color-text-muted);">Add content to get your spam score.</i>
                    </div>
                    
                    <!-- AI Enhancement Panel -->
                    <div class="mt-6 p-5 rounded-xl border-2 shadow-lg transition-all" style="background: linear-gradient(135deg, #f5f0ff 0%, white 100%); border-color: var(--color-blue-violet);">
                        <h3 class="text-lg font-semibold mb-4 flex items-center" style="color: var(--color-text);">
                            <i class="fas fa-magic mr-2" style="color: var(--color-blue-violet);"></i>AI-Powered Enhancements
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <button id="ai-optimize-btn" class="text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-blue-violet);">
                                <i class="fas fa-wand-magic-sparkles mr-2"></i>Optimize Content
                            </button>
                            <button id="ai-suggest-btn" class="text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-blue-violet);">
                                <i class="fas fa-lightbulb mr-2"></i>Get Suggestions
                            </button>
                            <button id="ai-tone-btn" class="text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-carrot-orange);">
                                <i class="fas fa-palette mr-2"></i>Adjust Tone
                            </button>
                            <button id="ai-subject-btn" class="text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-carrot-orange);">
                                <i class="fas fa-heading mr-2"></i>Generate Subject
                            </button>
                            <button id="ai-rewrite-spam-btn" class="text-white px-4 py-3 rounded-xl text-sm font-semibold transition-all flex items-center justify-center hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-poppy);">
                                <i class="fas fa-broom mr-2"></i>Rewrite Spam Words
                            </button>
                        </div>
                        <div id="ai-loading" class="hidden mt-4 p-4 rounded-xl" style="background: rgba(131, 56, 236, 0.1); border: 2px solid var(--color-blue-violet);">
                            <div class="flex items-center">
                                <div class="animate-spin rounded-full h-5 w-5 border-b-2 mr-3" style="border-color: var(--color-blue-violet);"></div>
                                <span class="text-sm font-medium" style="color: var(--color-blue-violet);">AI is working...</span>
                            </div>
                        </div>
                        <div id="ai-response" class="hidden mt-4 p-4 bg-white rounded-xl border-2" style="border-color: var(--color-blue-violet);">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold" style="color: var(--color-text);">AI Response</h4>
                                <button id="copy-ai-response" class="transition-colors" style="color: var(--color-text-muted);">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                            <div id="ai-content" class="text-sm" style="color: var(--color-text);"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visual Preview -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden" style="border: 2px solid var(--color-platinum);">
                <div class="p-6">
                    <!-- Fake Email Client UI -->
                    <div class="flex items-center space-x-4 pb-4 border-b-2" style="border-color: var(--color-platinum);">
                        <div class="w-12 h-12 text-white flex items-center justify-center rounded-xl font-bold text-lg shadow-md" style="background: linear-gradient(135deg, var(--color-blue-violet) 0%, var(--color-carrot-orange) 100%);">
                            <span id="sender-initial">R</span>
                        </div>
                        <div>
                            <p class="font-semibold" style="color: var(--color-text);">Rohan Patel</p>
                            <p class="text-sm" style="color: var(--color-text-muted);">To: <span id="recipient-email">recipient@example.com</span></p>
                        </div>
                    </div>
                    <!-- Subject Line Input -->
                    <div class="mb-4 mt-4">
                        <label class="text-sm font-semibold mb-2 block" style="color: var(--color-text);">Subject Line:</label>
                        <input type="text" id="subject-line-input" 
                               class="w-full p-3 text-white border-2 rounded-xl font-medium text-base transition-all focus:ring-2" 
                               style="background: var(--color-black); border-color: var(--color-platinum);"
                               placeholder="Enter your email subject line..."
                               value="Regarding AI Roles at {{company_name}}">
                        <div id="subject-line-preview" class="mt-2 text-sm p-3 rounded-xl border-2" style="color: var(--color-text-muted); background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span class="font-semibold" style="color: var(--color-text);">Preview:</span> <span id="subject-preview-text">Regarding AI Roles at {{company_name}}</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 border-b-2 pb-4" style="border-color: var(--color-platinum);">
                        <h3 class="text-xl font-bold" style="color: var(--color-text);">Regarding AI Roles at <span id="preview-company-name">Your Company</span></h3>
                    </div>
                    <!-- Toolbar -->
                    <div class="py-4">
                        <div id="toolbar" class="flex flex-wrap items-center gap-2 p-3 rounded-xl border-2" role="toolbar" aria-label="Text formatting toolbar" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <button class="toolbar-btn" data-command="bold" aria-label="Bold text (Ctrl+B)" title="Bold"><i class="fas fa-bold"></i></button>
                            <button class="toolbar-btn" data-command="italic" aria-label="Italic text (Ctrl+I)" title="Italic"><i class="fas fa-italic"></i></button>
                            <button class="toolbar-btn" data-command="underline" aria-label="Underline text (Ctrl+U)" title="Underline"><i class="fas fa-underline"></i></button>
                            <button class="toolbar-btn" data-command="strikeThrough" aria-label="Strikethrough text" title="Strikethrough"><i class="fas fa-strikethrough"></i></button>
                            <button class="toolbar-btn" data-command="createLink" aria-label="Insert link" title="Insert Link"><i class="fas fa-link"></i></button>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <button class="toolbar-btn" data-command="justifyLeft" aria-label="Align left" title="Align Left"><i class="fas fa-align-left"></i></button>
                            <button class="toolbar-btn" data-command="justifyCenter" aria-label="Align center" title="Align Center"><i class="fas fa-align-center"></i></button>
                            <button class="toolbar-btn" data-command="justifyRight" aria-label="Align right" title="Align Right"><i class="fas fa-align-right"></i></button>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <button class="toolbar-btn" data-command="insertOrderedList" aria-label="Numbered list" title="Numbered List"><i class="fas fa-list-ol"></i></button>
                            <button class="toolbar-btn" data-command="insertUnorderedList" aria-label="Bullet list" title="Bullet List"><i class="fas fa-list-ul"></i></button>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <select class="toolbar-select" data-command="fontName">
                                <option value="Arial">Arial</option> <option value="Verdana">Verdana</option> <option value="Georgia">Georgia</option> <option value="Times New Roman">Times</option> <option value="Courier New">Courier</option>
                            </select>
                            <select class="toolbar-select" data-command="fontSize">
                                <option value="1">Small</option> <option value="3" selected>Normal</option> <option value="5">Large</option> <option value="7">Huge</option>
                            </select>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <div class="flex items-center rounded-lg" style="background: var(--color-platinum);">
                                <span class="px-3" style="color: var(--color-text);"><i class="fas fa-palette"></i></span>
                                <input type="color" class="w-8 h-8 bg-transparent border-l-2 cursor-pointer" style="border-color: var(--color-platinum-dark);" data-command="foreColor" value="#000000" title="Text Color">
                            </div>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <button class="toolbar-btn" data-command="removeFormat" aria-label="Clear formatting" title="Clear Formatting"><i class="fas fa-eraser"></i></button>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <button id="undo-btn" class="toolbar-btn" aria-label="Undo (Ctrl+Z)" title="Undo (Ctrl+Z)"><i class="fas fa-undo"></i></button>
                            <button id="redo-btn" class="toolbar-btn" aria-label="Redo (Ctrl+Y)" title="Redo (Ctrl+Y)"><i class="fas fa-redo"></i></button>
                            <div class="h-6 border-l-2" style="border-color: var(--color-platinum);"></div>
                            <button id="help-btn" class="toolbar-btn" aria-label="Show keyboard shortcuts" title="Keyboard Shortcuts"><i class="fas fa-question-circle"></i></button>
                        </div>
                    </div>
                    <!-- Email Body -->
                    <div id="email-preview" contenteditable="true" class="prose prose-sm max-w-none leading-relaxed p-5 border-2 rounded-xl transition-all" style="min-height: 300px; color: var(--color-text); border-color: var(--color-platinum); background: white;">
                        <!-- Rendered HTML will go here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy to clipboard feedback message -->
    <div id="copy-feedback" class="fixed bottom-20 right-5 text-white py-3 px-6 rounded-xl shadow-2xl transition-all duration-300 opacity-0 pointer-events-none font-semibold" style="background: var(--color-carrot-orange);">
        <i class="fas fa-check-circle mr-2"></i>Copied to clipboard!
    </div>

    <!-- Custom Link Modal -->
    <div id="link-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="link-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border-2 transform transition-all" style="border-color: var(--color-blue-violet);">
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" style="background: linear-gradient(135deg, var(--color-blue-violet), var(--color-carrot-orange));">
                        <i class="fas fa-link text-white"></i>
                    </div>
                    <h2 id="link-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Insert Link</h2>
                </div>
                <p class="text-sm" style="color: var(--color-text-muted);">Enter the URL you want to link to</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label for="link-url-input" class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                        <i class="fas fa-globe mr-1" style="color: var(--color-blue-violet);"></i>URL
                    </label>
                    <input 
                        type="url" 
                        id="link-url-input" 
                        class="input-field" 
                        placeholder="https://example.com"
                        style="border-color: var(--color-platinum);"
                    >
                </div>
                
                <div>
                    <label for="link-text-input" class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                        <i class="fas fa-text-width mr-1" style="color: var(--color-blue-violet);"></i>Link Text (optional)
                    </label>
                    <input 
                        type="text" 
                        id="link-text-input" 
                        class="input-field" 
                        placeholder="Enter link text"
                        style="border-color: var(--color-platinum);"
                    >
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancel-link-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-md" style="background: var(--color-platinum); color: var(--color-text);">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="insert-link-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-blue-violet);">
                    <i class="fas fa-check mr-2"></i>Insert Link
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Tone Modal -->
    <div id="tone-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="tone-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border-2 transform transition-all" style="border-color: var(--color-carrot-orange);">
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" style="background: linear-gradient(135deg, var(--color-carrot-orange), var(--color-blue-violet));">
                        <i class="fas fa-palette text-white"></i>
                    </div>
                    <h2 id="tone-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Adjust Tone</h2>
                </div>
                <p class="text-sm" style="color: var(--color-text-muted);">Choose the tone style for your email content</p>
            </div>
            
            <div>
                <label for="tone-input" class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                    <i class="fas fa-wand-magic-sparkles mr-1" style="color: var(--color-carrot-orange);"></i>Tone Style
                </label>
                <input 
                    type="text" 
                    id="tone-input" 
                    class="input-field" 
                    placeholder="e.g., professional, friendly, urgent, casual"
                    style="border-color: var(--color-platinum);"
                >
                <div class="mt-3 flex flex-wrap gap-2">
                    <button class="tone-preset px-3 py-1.5 rounded-lg text-sm font-medium transition-all" style="background: var(--color-platinum); color: var(--color-text);" data-tone="professional">Professional</button>
                    <button class="tone-preset px-3 py-1.5 rounded-lg text-sm font-medium transition-all" style="background: var(--color-platinum); color: var(--color-text);" data-tone="friendly">Friendly</button>
                    <button class="tone-preset px-3 py-1.5 rounded-lg text-sm font-medium transition-all" style="background: var(--color-platinum); color: var(--color-text);" data-tone="urgent">Urgent</button>
                    <button class="tone-preset px-3 py-1.5 rounded-lg text-sm font-medium transition-all" style="background: var(--color-platinum); color: var(--color-text);" data-tone="casual">Casual</button>
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancel-tone-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-md" style="background: var(--color-platinum); color: var(--color-text);">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="apply-tone-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-carrot-orange);">
                    <i class="fas fa-check mr-2"></i>Apply Tone
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Save Template Modal -->
    <div id="save-template-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="save-template-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border-2 transform transition-all" style="border-color: var(--color-carrot-orange);">
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" style="background: linear-gradient(135deg, var(--color-carrot-orange), var(--color-blue-violet));">
                        <i class="fas fa-save text-white"></i>
                    </div>
                    <h2 id="save-template-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Save Template</h2>
                </div>
                <p class="text-sm" style="color: var(--color-text-muted);">Give your template a memorable name</p>
            </div>
            
            <div>
                <label for="template-name-input" class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                    <i class="fas fa-tag mr-1" style="color: var(--color-carrot-orange);"></i>Template Name
                </label>
                <input 
                    type="text" 
                    id="template-name-input" 
                    class="input-field" 
                    placeholder="e.g., Welcome Email, Follow-up Template"
                    style="border-color: var(--color-platinum);"
                >
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancel-save-template-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-md" style="background: var(--color-platinum); color: var(--color-text);">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="confirm-save-template-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-carrot-orange);">
                    <i class="fas fa-check mr-2"></i>Save Template
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Load Template Modal -->
    <div id="load-template-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="load-template-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl border-2 transform transition-all" style="border-color: var(--color-blue-violet);">
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" style="background: linear-gradient(135deg, var(--color-blue-violet), var(--color-carrot-orange));">
                        <i class="fas fa-folder-open text-white"></i>
                    </div>
                    <h2 id="load-template-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Load Template</h2>
                </div>
                <p class="text-sm" style="color: var(--color-text-muted);">Select a template to load</p>
            </div>
            
            <div>
                <label class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                    <i class="fas fa-list mr-1" style="color: var(--color-blue-violet);"></i>Available Templates
                </label>
                <div id="template-list" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                    <!-- Templates will be populated here -->
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancel-load-template-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-md" style="background: var(--color-platinum); color: var(--color-text);">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Spam Rewrite Modal -->
    <div id="spam-rewrite-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="spam-rewrite-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 shadow-2xl border-2 transform transition-all" style="border-color: var(--color-poppy);">
            <div class="mb-6">
                <div class="flex items-center mb-2">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center mr-3" style="background: linear-gradient(135deg, var(--color-poppy), var(--color-carrot-orange));">
                        <i class="fas fa-broom text-white"></i>
                    </div>
                    <h2 id="spam-rewrite-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Rewrite Spam Words</h2>
                </div>
                <p class="text-sm" style="color: var(--color-text-muted);">Enter words/phrases to rewrite (comma-separated)</p>
            </div>
            
            <div>
                <label for="spam-words-input" class="block text-sm font-semibold mb-2" style="color: var(--color-text);">
                    <i class="fas fa-exclamation-triangle mr-1" style="color: var(--color-poppy);"></i>Spam Words/Phrases
                </label>
                <textarea 
                    id="spam-words-input" 
                    class="input-field" 
                    rows="4"
                    placeholder="e.g., Name, Only, Open, Solution"
                    style="border-color: var(--color-platinum); resize: vertical; min-height: 100px;"
                ></textarea>
                <p class="text-xs mt-2" style="color: var(--color-text-muted);">
                    <i class="fas fa-info-circle mr-1"></i>Leave empty to use detected spam words automatically
                </p>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button id="cancel-spam-rewrite-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold transition-all hover:shadow-md" style="background: var(--color-platinum); color: var(--color-text);">
                    <i class="fas fa-times mr-2"></i>Cancel
                </button>
                <button id="confirm-spam-rewrite-btn" class="flex-1 px-6 py-3 rounded-xl font-semibold text-white transition-all hover:shadow-lg hover:-translate-y-0.5" style="background: var(--color-poppy);">
                    <i class="fas fa-check mr-2"></i>Rewrite Words
                </button>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto shadow-2xl border-2" style="border-color: var(--color-blue-violet);">
            <div class="flex justify-between items-center mb-6">
                <h2 id="help-modal-title" class="text-2xl font-bold" style="color: var(--color-text);">Keyboard Shortcuts & Help</h2>
                <button id="close-help" class="text-2xl w-10 h-10 rounded-lg transition-all" style="color: var(--color-text-muted);" onmouseover="this.style.background='var(--color-platinum)'" onmouseout="this.style.background='transparent'">&times;</button>
            </div>
            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-blue-violet);">Keyboard Shortcuts</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Bold</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+B</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Italic</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+I</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Underline</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+U</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Undo</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+Z</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Redo</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+Y</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Save Template</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-carrot-orange); color: white;">Ctrl+S</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">Copy HTML</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+Shift+C</kbd>
                        </div>
                        <div class="flex justify-between items-center p-3 rounded-lg border-2 transition-all hover:shadow-md" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                            <span style="color: var(--color-text);">AI Optimize</span>
                            <kbd class="px-3 py-1.5 rounded-lg text-sm font-semibold" style="background: var(--color-blue-violet); color: white;">Ctrl+O</kbd>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3" style="color: var(--color-carrot-orange);">Features</h3>
                    <ul class="space-y-2" style="color: var(--color-text);">
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>Real-time spam checking with keyword highlighting</li>
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>AI-powered content optimization and suggestions</li>
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>Template variables with live preview</li>
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>Rich text editor with formatting tools</li>
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>Auto-save functionality</li>
                        <li class="flex items-start"><i class="fas fa-check mr-2 mt-1" style="color: var(--color-carrot-orange);"></i>Template library and management</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="fixed bottom-0 left-0 right-0 text-white py-3 px-6 text-sm flex justify-between items-center z-40 backdrop-blur-lg border-t-2" style="background: linear-gradient(135deg, var(--color-black) 0%, #1a191a 100%); border-color: var(--color-platinum);">
        <div class="flex items-center space-x-6">
            <span id="auto-save-status" class="flex items-center font-medium">
                <i class="fas fa-save mr-2" style="color: var(--color-carrot-orange);"></i>
                <span>Auto-saved</span>
            </span>
            <span id="word-count" class="flex items-center">
                <i class="fas fa-font mr-2" style="color: var(--color-blue-violet);"></i>
                <span>Words: 0</span>
            </span>
            <span id="char-count" class="flex items-center">
                <i class="fas fa-keyboard mr-2" style="color: var(--color-blue-violet);"></i>
                <span>Characters: 0</span>
            </span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="last-saved" class="font-medium" style="color: var(--color-platinum);">
                Last saved: Just now
            </span>
        </div>
    </div>

    <!-- Spam Filter Script (External) -->
    <script src="spam-filter.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const EmailEditor = {
            nodes: {},
            state: { savedSelection: null },
            defaultPromptTemplates: {
                optimize: `{systemPrompt}

### GOAL
Rewrite the user's email content to be more professional, engaging, and effective, maximizing both deliverability and conversion potential.

### INSTRUCTIONS
1.  **Analyze the original email:** Internally, evaluate the email against the AIDA framework (Attention, Interest, Desire, Action). Identify its weakest points.
2.  **Rewrite for Impact:** Revise the email to strengthen each AIDA stage. Improve the opening hook, clarify the value proposition, create a stronger desire for the offer, and write a clearer, more compelling call-to-action.
3.  **Ensure Professionalism:** Refine the language to be professional and persuasive. Eliminate spam trigger words and awkward phrasing.

### CONSTRAINTS
- The rewritten content must remain under 200 words.
- Preserve the original intent and key information (company names, links, contact details).
- Do not add any commentary or explanation.

### OUTPUT FORMAT
Return only the rewritten email content in its original HTML format.

### ORIGINAL EMAIL CONTENT
{content}`,
                suggest: `{systemPrompt}

### GOAL
Analyze the provided email content and subject line, then provide a concise list of the most critical, actionable suggestions for improvement.

### INSTRUCTIONS
Structure your feedback into the following four sections, using the exact markdown format shown in the example below:
1.  **Subject Line:** Suggest one powerful alternative.
2.  **Opening:** Recommend a change to the first sentence to make it more compelling.
3.  **Call-to-Action (CTA):** Propose a more direct and persuasive CTA.
4.  **Deliverability:** Identify one key change to avoid spam filters.

### CONSTRAINTS
- Your entire response must be under 150 words.
- Be extremely specific and actionable.

### EXAMPLE
**Input Content:** "Hello, check out our new product. It's on sale for a limited time only! Click here to buy now."
**Perfect Output:**
**1. Subject Line:** Instead of "New Product," try "Your Exclusive First Look at [Product Name]."
**2. Opening:** Start with the main benefit, such as "Solve [Problem] in minutes with our new..."
**3. Call-to-Action (CTA):** Change "Click here" to a value-focused CTA like "Get Your [Product Name] Now."
**4. Deliverability:** Avoid the phrase "limited time only," as it can trigger spam filters. Use "offer ends Friday" instead.

### EMAIL TO ANALYZE
Subject: {subjectLine}
Content: {content}`,
                tone: `{systemPrompt}

### GOAL
Rewrite the provided email content to match a {tone} tone, ensuring the core message, structure, and all details (links, variables) remain intact.

### CONSTRAINTS
- Return only the rewritten email content.
- Do not include any introductory text, explanations, or labels.

### ORIGINAL CONTENT
{content}`,
                subject: `{systemPrompt}

### GOAL
Generate {numSubjects} compelling, high-converting subject lines for the provided email content.

### INSTRUCTIONS
- Analyze the email's core value proposition.
- Create subject lines that are intriguing, benefit-oriented, and personalized.
- If the original subject uses variables like {{company_name}}, you may use them in your suggestions.

### OUTPUT FORMAT
Return only the {numSubjects} subject lines, one per line. Do not use numbers, bullets, or any extra text.

### EMAIL CONTEXT
Current Subject: {subjectLine}
Email Content: {content}`,
                rewrite: `{systemPrompt}

### GOAL
Analyze the provided EMAIL_HTML and replace specific spam-trigger words/phrases from the TERMS list with safer, more professional alternatives.

### CRITICAL RULES
1.  **Format:** Your output MUST be a valid JSON array of objects with the shape: [{"from": "original_word", "to": "replacement_word"}].
2.  **Replacements:** NEVER suggest the same word as a replacement. The "to" value must be a meaningful improvement.
3.  **Safety:** The "to" value must be a natural, non-spammy alternative.
4.  **Precision:** Replace ONLY the provided words when they appear as standalone text. Do NOT alter HTML tags, attributes, links, or variables (e.g., {{name}}). Match case where sensible.
5.  **Omission:** If you cannot find a genuinely better replacement for a term, OMIT it from the final JSON array.

### EXAMPLE
**TERMS:** ["free gift", "act now"]
**Perfect Output:** [{"from":"free gift","to":"complimentary gift"},{"from":"act now","to":"get started"}]

### TERMS TO REPLACE
{terms}

### EMAIL_HTML
{content}`
            },
            aiReady() {
                if (!navigator.onLine) {
                    this.showAIError('You are offline. Check your internet connection.');
                    return false;
                }
                if (!window.GoogleGenerativeAI) {
                    this.showAIError('Gemini AI library is not loaded. Please refresh the page.');
                    return false;
                }
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey || !apiKey.trim()) {
                    this.showAIError('No Gemini API key found. Please add your API key in Settings.');
                    return false;
                }
                return true;
            },

            getPromptTemplate(key) {
                const stored = localStorage.getItem(`prompt-${key}`);
                if (stored && stored.trim()) return stored;
                return this.defaultPromptTemplates[key] || '';
            },

            initGeminiClient(featureKey) {
                const apiKey = localStorage.getItem('gemini-api-key');
                if (!apiKey) throw new Error('No Gemini API key found');

                const genAI = new window.GoogleGenerativeAI(apiKey);

                const mode = localStorage.getItem('ai-temperature-mode') || 'normal';
                let tempKey;
                if (mode === 'advanced' && featureKey) {
                    tempKey = `ai-temperature-${featureKey}`;
                } else {
                    tempKey = 'ai-temperature';
                }

                // Fallback chain: specific advanced temp -> global temp -> default 1.0
                const temperature = parseFloat(
                    localStorage.getItem(tempKey) || localStorage.getItem('ai-temperature') || '1.0'
                );

                return genAI.getGenerativeModel({
                    model: "gemini-2.5-flash-lite",
                    generationConfig: {
                        temperature: temperature,
                        thinkingConfig: { thinkingBudget: 0 }
                    }
                });
            },

            renderPrompt(template, variables) {
                if (!template) return '';
                let result = template.replace(/\{(\w+)\}/g, (m, k) => {
                    const val = Object.prototype.hasOwnProperty.call(variables, k) ? variables[k] : '';
                    return val == null ? '' : String(val);
                });
                
                // Add subjectLine support if not already provided
                // Use raw subject line with variables for AI context
                if (this.nodes.subjectLineInput && !variables.hasOwnProperty('subjectLine')) {
                    result = result.replace(/\{subjectLine\}/g, this.nodes.subjectLineInput.value || '');
                }
                
                return result;
            },

            extractAIText(response) {
                try {
                    if (!response) return null;
                    
                    // Gemini response format
                    if (response.response && response.response.text) {
                        return response.response.text();
                    }
                    
                    // Fallback for other formats
                    if (typeof response === 'string') return response;
                    
                    return null;
                } catch (error) {
                    console.error('Error extracting AI text:', error);
                    return null;
                }
            },

            init() {
                this.queryNodes();
                this.bindEvents();
                this.initAutoSave();
                this.initKeyboardShortcuts();
                this.initHelpModal();
                this.loadCustomSpamWords();
                
                // Load previous work or use defaults
                this.loadFromLocalStorage();
                
                // Check if no saved data exists (no HTML content and no variables loaded)
                if (!this.nodes.htmlInput.value && this.nodes.variablesContainer.children.length === 0) {
                    // Add default variables
                    this.addVariableRow('full_name', 'Rahul');
                    this.addVariableRow('company_name', 'Infosys');
                    this.addVariableRow('Date', '16/01/2024');
                    this.addVariableRow('other_locations', 'Delhi, Gurgaon, Mumbai, Lucknow');
                    this.addVariableRow('location', 'Ahmedabad');
                    this.addVariableRow('clients', 'Tavant Technologies, ICICI, KENT RO, Mapro Foods, NP Digital');
                    this.nodes.htmlInput.value = this.getDefaultHtml();
                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                } else if (!this.nodes.htmlInput.value) {
                    // Only set default HTML if no content exists but variables might be loaded
                    this.nodes.htmlInput.value = this.getDefaultHtml();
                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                // Initialize subject line preview
                this.renderSubjectLine();
                
                // Check if signature should be inserted
                if (localStorage.getItem('insert-signature-flag') === 'true') {
                    this.insertSignature();
                    localStorage.removeItem('insert-signature-flag');
                }
                
                // Add event delegation for AI action buttons
                document.addEventListener('click', (e) => {
                    const btn = e.target.closest('[data-action]');
                    if (!btn) return;
                    
                    const action = btn.dataset.action;
                    const contentId = btn.dataset.contentId;
                    const content = window.aiContentCache?.[contentId];
                    
                    if (!content) return;
                    
                    switch (action) {
                        case 'copy':
                            this.copyToClipboard(content);
                            break;
                        case 'apply':
                            this.applyToEditor(content);
                            break;
                        case 'use':
                            this.useSubject(content);
                            break;
                    }
                });
                
                this.updateWordCount();
            },

            queryNodes() {
                this.nodes = {
                    variablesContainer: document.getElementById('variables-container'),
                    addVariableBtn: document.getElementById('add-variable-btn'),
                    htmlInput: document.getElementById('spam-checker--textarea'),
                    emailPreview: document.getElementById('email-preview'),
                    subjectLineInput: document.getElementById('subject-line-input'),
                    subjectPreviewText: document.getElementById('subject-preview-text'),
                    recipientEmail: document.getElementById('recipient-email'),
                    previewCompanyName: document.getElementById('preview-company-name'),
                    copyHtmlBtn: document.getElementById('copy-html-btn'),
                    copyFeedback: document.getElementById('copy-feedback'),
                    senderInitial: document.getElementById('sender-initial'),
                    toolbar: document.getElementById('toolbar'),
                };
            },

            bindEvents() {
                // Existing events
                this.nodes.addVariableBtn.addEventListener('click', () => this.addVariableRow());
                
                // Debounce heavy operations on input
                const debouncedRender = window.EmailEditorUtils?.debounce(() => {
                    this.renderPreview();
                }, 300) || (() => this.renderPreview());
                
                this.nodes.htmlInput.addEventListener('input', () => {
                    debouncedRender();
                    this.updateWordCount();
                    this.saveToLocalStorage();
                });
                this.nodes.subjectLineInput.addEventListener('input', () => {
                    this.renderSubjectLine();
                    this.saveToLocalStorage();
                });
                this.nodes.emailPreview.addEventListener('input', () => {
                    this.styleAllLinks();
                    this.updateSourceFromPreview();
                });
                this.nodes.copyHtmlBtn.addEventListener('click', () => this.copyHtmlToClipboard());

                // Toolbar events
                this.nodes.toolbar.addEventListener('click', e => {
                    const commandElement = e.target.closest('[data-command]');
                    if (commandElement) this.applyCommand(commandElement);
                });
                this.nodes.toolbar.addEventListener('change', e => {
                    const commandElement = e.target.closest('[data-command]');
                    if (commandElement) this.applyCommand(commandElement);
                });

                // New template management events
                document.getElementById('save-template-btn').addEventListener('click', () => this.saveTemplate());
                document.getElementById('load-template-btn').addEventListener('click', () => this.loadTemplate());
                document.getElementById('clear-all-btn').addEventListener('click', () => this.clearAll());
                document.getElementById('settings-btn').addEventListener('click', () => window.location.href = 'settings.html');

                // AI enhancement events
                document.getElementById('ai-optimize-btn').addEventListener('click', () => this.optimizeWithAI());
                document.getElementById('ai-suggest-btn').addEventListener('click', () => this.getAISuggestions());
                document.getElementById('ai-tone-btn').addEventListener('click', () => this.adjustTone());
                document.getElementById('ai-subject-btn').addEventListener('click', () => this.generateSubject());
                document.getElementById('ai-rewrite-spam-btn').addEventListener('click', () => this.rewriteSpamWords());
                document.getElementById('copy-ai-response').addEventListener('click', () => {
                    const aiContent = document.getElementById('ai-content').textContent;
                    navigator.clipboard.writeText(aiContent);
                    this.showNotification('AI response copied to clipboard!');
                });

                // Undo/Redo buttons
                document.getElementById('undo-btn').addEventListener('click', () => this.undo());
                document.getElementById('redo-btn').addEventListener('click', () => this.redo());

                // Link modal events
                document.getElementById('insert-link-btn').addEventListener('click', () => this.insertLink());
                document.getElementById('cancel-link-btn').addEventListener('click', () => this.hideLinkModal());
                
                // Close modal on Enter key in URL input
                document.getElementById('link-url-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.insertLink();
                    }
                });
                
                // Close modal on Escape key
                document.getElementById('link-modal').addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideLinkModal();
                    }
                });
                
                // Close modal when clicking backdrop
                document.getElementById('link-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'link-modal') {
                        this.hideLinkModal();
                    }
                });
                
                // Help modal events
                document.getElementById('help-btn').addEventListener('click', () => {
                    document.getElementById('help-modal').classList.remove('hidden');
                });
                document.getElementById('close-help').addEventListener('click', () => {
                    document.getElementById('help-modal').classList.add('hidden');
                });
                document.getElementById('help-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'help-modal') {
                        document.getElementById('help-modal').classList.add('hidden');
                    }
                });
                
                // Tone modal events
                document.getElementById('apply-tone-btn').addEventListener('click', () => this.applyToneAdjustment());
                document.getElementById('cancel-tone-btn').addEventListener('click', () => this.hideToneModal());
                document.getElementById('tone-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.applyToneAdjustment();
                    }
                });
                document.querySelectorAll('.tone-preset').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.getElementById('tone-input').value = e.target.dataset.tone;
                    });
                });
                document.getElementById('tone-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'tone-modal') this.hideToneModal();
                });
                
                // Save template modal events
                document.getElementById('confirm-save-template-btn').addEventListener('click', () => this.confirmSaveTemplate());
                document.getElementById('cancel-save-template-btn').addEventListener('click', () => this.hideSaveTemplateModal());
                document.getElementById('template-name-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.confirmSaveTemplate();
                    }
                });
                document.getElementById('save-template-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'save-template-modal') this.hideSaveTemplateModal();
                });
                
                // Load template modal events
                document.getElementById('cancel-load-template-btn').addEventListener('click', () => this.hideLoadTemplateModal());
                document.getElementById('load-template-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'load-template-modal') this.hideLoadTemplateModal();
                });
                
                // Spam rewrite modal events
                document.getElementById('confirm-spam-rewrite-btn').addEventListener('click', () => this.confirmSpamRewrite());
                document.getElementById('cancel-spam-rewrite-btn').addEventListener('click', () => this.hideSpamRewriteModal());
                document.getElementById('spam-rewrite-modal').addEventListener('click', (e) => {
                    if (e.target.id === 'spam-rewrite-modal') this.hideSpamRewriteModal();
                });

                // If spam keywords load after initial render, re-highlight preview
                document.addEventListener('spamKeywordsReady', () => {
                    this.highlightSpamInPreview();
                });
            },
            
            applyCommand(element) {
                const { command } = element.dataset;
                let value = element.value || null;

                if (command === 'createLink') {
                    this.state.savedSelection = this.saveSelection(this.nodes.emailPreview);
                    this.showLinkModal();
                    return;
                }
                
                this.nodes.emailPreview.focus();

                if (this.state.savedSelection) {
                    this.restoreSelection(this.nodes.emailPreview, this.state.savedSelection);
                }

                document.execCommand(command, false, value);
                this.state.savedSelection = null;
                this.updateSourceFromPreview();
            },
            
            showLinkModal() {
                const linkModal = document.getElementById('link-modal');
                const linkUrlInput = document.getElementById('link-url-input');
                const linkTextInput = document.getElementById('link-text-input');
                
                // Get selected text if any
                const selection = window.getSelection();
                const selectedText = selection.toString();
                
                // Pre-fill link text with selected text
                linkTextInput.value = selectedText;
                linkUrlInput.value = 'https://';
                
                linkModal.classList.remove('hidden');
                setTimeout(() => linkUrlInput.focus(), 100);
            },
            
            hideLinkModal() {
                const linkModal = document.getElementById('link-modal');
                linkModal.classList.add('hidden');
            },
            
            insertLink() {
                const linkUrlInput = document.getElementById('link-url-input');
                const linkTextInput = document.getElementById('link-text-input');
                const url = linkUrlInput.value.trim();
                
                // Validate URL
                const validation = window.EmailEditorUtils?.validateUrl(url) || 
                    { isValid: url && url !== 'https://', error: 'Invalid URL' };
                
                if (!validation.isValid) {
                    this.showNotification(validation.error, 'error');
                    linkUrlInput.style.borderColor = 'var(--color-poppy)';
                    const flashDuration = window.EMAIL_EDITOR_CONSTANTS?.BORDER_FLASH_DURATION_MS || 1500;
                    setTimeout(() => {
                        linkUrlInput.style.borderColor = 'var(--color-platinum)';
                    }, flashDuration);
                    return;
                }
                
                this.nodes.emailPreview.focus();
                
                if (this.state.savedSelection) {
                    this.restoreSelection(this.nodes.emailPreview, this.state.savedSelection);
                }
                
                // If custom text is provided, replace selection with it first
                const linkText = linkTextInput.value.trim();
                if (linkText && window.getSelection().toString() !== linkText) {
                    document.execCommand('insertText', false, linkText);
                    // Re-select the inserted text
                    const selection = window.getSelection();
                    const range = document.createRange();
                    const textNode = selection.anchorNode;
                    if (textNode && textNode.nodeType === Node.TEXT_NODE) {
                        range.setStart(textNode, textNode.textContent.length - linkText.length);
                        range.setEnd(textNode, textNode.textContent.length);
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                }
                
                document.execCommand('createLink', false, url);
                
                // Apply custom styling to the newly created link
                setTimeout(() => {
                    const selection = window.getSelection();
                    if (selection.anchorNode) {
                        let element = selection.anchorNode.parentElement;
                        // Find the anchor tag
                        while (element && element.tagName !== 'A' && element !== this.nodes.emailPreview) {
                            element = element.parentElement;
                        }
                        if (element && element.tagName === 'A') {
                            element.style.color = '#0400ff';
                            element.style.textDecoration = 'underline';
                            // Wrap content in font tag with color for better email client compatibility
                            if (element.innerHTML && !element.querySelector('font[color="#0400ff"]')) {
                                element.innerHTML = `<font color="#0400ff"><u>${element.textContent}</u></font>`;
                            }
                        }
                    }
                    this.updateSourceFromPreview();
                }, 50);
                
                this.state.savedSelection = null;
                this.hideLinkModal();
                
                // Clear inputs
                linkUrlInput.value = '';
                linkTextInput.value = '';
            },

            renderPreview() {
                let template = this.nodes.htmlInput.value;
                const variables = this.getVariables();

                variables.forEach((value, name) => {
                    const regex = new RegExp(`{{${name}}}`, 'g');
                    template = template.replace(regex, `<span class=\"font-semibold text-blue-600\" data-variable=\"${name}\" contenteditable=\"false\">${value}</span>`);
                });

                this.nodes.recipientEmail.textContent = `${(variables.get('name') || 'recipient').split(' ')[0].toLowerCase()}@example.com`;
                this.nodes.previewCompanyName.textContent = variables.get('company_name') || 'Your Company';
                
                // Render subject line preview with variable replacement
                this.renderSubjectLine();
                
                const selection = this.saveSelection(this.nodes.emailPreview);
                this.nodes.emailPreview.innerHTML = template;
                // Apply spam highlights in the preview before restoring selection
                this.highlightSpamInPreview();
                // Apply link styling to all links
                this.styleAllLinks();
                this.restoreSelection(this.nodes.emailPreview, selection);
            },
            
            styleAllLinks() {
                // Find all anchor tags in the email preview and apply styling
                const links = this.nodes.emailPreview.querySelectorAll('a');
                links.forEach(link => {
                    link.style.color = '#0400ff';
                    link.style.textDecoration = 'underline';
                    // Ensure proper HTML structure for email clients
                    if (link.innerHTML && !link.querySelector('font[color="#0400ff"]')) {
                        const text = link.textContent;
                        link.innerHTML = `<font color="#0400ff"><u>${text}</u></font>`;
                    }
                });
            },

            renderSubjectLine() {
                if (!this.nodes.subjectLineInput) return;
                
                // Update the preview text with rendered variables
                if (this.nodes.subjectPreviewText) {
                    const renderedSubject = this.getRenderedSubjectLine();
                    this.nodes.subjectPreviewText.textContent = renderedSubject;
                }
            },

            getRenderedSubjectLine() {
                if (!this.nodes.subjectLineInput) return '';
                
                let subjectLine = this.nodes.subjectLineInput.value;
                const variables = this.getVariables();

                variables.forEach((value, name) => {
                    const regex = new RegExp(`{{${name}}}`, 'g');
                    subjectLine = subjectLine.replace(regex, value);
                });

                return subjectLine;
            },

            updateSourceFromPreview() {
                const selection = this.saveSelection(this.nodes.emailPreview);
                const tempDiv = this.nodes.emailPreview.cloneNode(true);

                tempDiv.querySelectorAll('span[data-variable]').forEach(span => {
                    const name = span.getAttribute('data-variable');
                    span.replaceWith(`{{${name}}}`);
                });
                // Remove spam highlight marks before syncing back to source
                tempDiv.querySelectorAll('mark').forEach(mark => {
                    mark.replaceWith(mark.textContent);
                });
                
                const newHtml = tempDiv.innerHTML;
                if (this.nodes.htmlInput.value !== newHtml) {
                    this.nodes.htmlInput.value = newHtml;
                    $(this.nodes.htmlInput).highlightWithinTextarea('update');
                    // Trigger the normal pipeline (renderPreview, counts, autosave)
                    // so that newly typed placeholders like {{name}} in the preview
                    // are immediately recognized and rendered.
                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                    return; // renderPreview will handle highlights and selection restore
                }
                // Reapply preview highlights after syncing source
                this.highlightSpamInPreview();
                this.restoreSelection(this.nodes.emailPreview, selection);
            },

            getVariables() {
                const variables = new Map();
                this.nodes.variablesContainer.querySelectorAll('.variable-row').forEach(row => {
                    const name = row.querySelector('.variable-name').value.trim();
                    const value = row.querySelector('.variable-value').value;
                    if (name) variables.set(name, value);
                });
                return variables;
            },

            addVariableRow(name = '', value = '') {
                const row = document.createElement('div');
                row.className = 'flex items-center space-x-2 variable-row';
                row.innerHTML = `
                    <input type=\"text\" value=\"${name}\" placeholder=\"Variable Name\" class=\"variable-name input-field w-1/3 text-sm\">
                    <span class=\"text-slate-400\">=</span>
                    <input type=\"text\" value=\"${value}\" placeholder=\"Value\" class=\"variable-value input-field flex-grow text-sm\">
                    <button class=\"remove-variable-btn text-slate-400 hover:text-red-500 transition-colors p-2 rounded-full\">\n                        <i class=\"fas fa-trash-alt fa-sm\"></i>\n                    </button>
                `;
                this.nodes.variablesContainer.appendChild(row);

                const updateHandler = () => {
                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                };
                row.querySelector('.variable-name').addEventListener('input', updateHandler);
                row.querySelector('.variable-value').addEventListener('input', updateHandler);
                row.querySelector('.remove-variable-btn').addEventListener('click', () => {
                    row.remove();
                    updateHandler();
                });
            },

            copyHtmlToClipboard() {
                navigator.clipboard.writeText(this.nodes.htmlInput.value).then(() => {
                    this.nodes.copyFeedback.classList.remove('opacity-0');
                    setTimeout(() => this.nodes.copyFeedback.classList.add('opacity-0'), 2000);
                }).catch(err => console.error('Failed to copy text: ', err));
            },

            saveSelection(containerEl) {
                const selection = window.getSelection();
                if (selection.rangeCount === 0) return null;
                const range = selection.getRangeAt(0);
                if (!containerEl.contains(range.commonAncestorContainer)) return null;
                const preSelectionRange = range.cloneRange();
                preSelectionRange.selectNodeContents(containerEl);
                preSelectionRange.setEnd(range.startContainer, range.startOffset);
                const start = preSelectionRange.toString().length;
                return { start: start, end: start + range.toString().length };
            },

            restoreSelection(containerEl, savedSel) {
                if (!savedSel) return;
                let charIndex = 0;
                const range = document.createRange();
                range.setStart(containerEl, 0);
                range.collapse(true);
                const nodeStack = [containerEl];
                let node, foundStart = false, stop = false;
                while (!stop && (node = nodeStack.pop())) {
                    if (node.nodeType === 3) {
                        const nextCharIndex = charIndex + node.length;
                        if (!foundStart && savedSel.start >= charIndex && savedSel.start <= nextCharIndex) {
                            range.setStart(node, savedSel.start - charIndex);
                            foundStart = true;
                        }
                        if (foundStart && savedSel.end >= charIndex && savedSel.end <= nextCharIndex) {
                            range.setEnd(node, savedSel.end - charIndex);
                            stop = true;
                        }
                        charIndex = nextCharIndex;
                    } else {
                        let i = node.childNodes.length;
                        while (i--) nodeStack.push(node.childNodes[i]);
                    }
                }
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            },
            
            // Highlight spam keywords inside the preview (text nodes only)
            highlightSpamInPreview() {
                const container = this.nodes.emailPreview;
                if (!window.spamKeywords || !container) return;
                this.clearSpamMarks(container);

                const textNodes = [];
                const walker = document.createTreeWalker(
                    container,
                    NodeFilter.SHOW_TEXT,
                    {
                        acceptNode: (node) => {
                            if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                            const parent = node.parentElement;
                            if (!parent) return NodeFilter.FILTER_REJECT;
                            const tag = parent.tagName;
                            if (tag === 'SCRIPT' || tag === 'STYLE') return NodeFilter.FILTER_REJECT;
                            return NodeFilter.FILTER_ACCEPT;
                        }
                    }
                );
                let node;
                while ((node = walker.nextNode())) textNodes.push(node);

                textNodes.forEach(textNode => {
                    const text = textNode.nodeValue;
                    const ranges = [];
                    window.spamKeywords.forEach(k => {
                        if (!(k.highlight instanceof RegExp)) return;
                        const flags = k.highlight.flags.includes('g') ? k.highlight.flags : (k.highlight.flags + 'g');
                        const r = new RegExp(k.highlight.source, flags);
                        r.lastIndex = 0;
                        let m;
                        while ((m = r.exec(text)) !== null) {
                            ranges.push({ start: m.index, end: m.index + m[0].length, category: k.category, keyword: k.keyword });
                            if (!r.global) break;
                            if (m.index === r.lastIndex) r.lastIndex++; // avoid zero-length loops
                        }
                    });
                    if (ranges.length === 0) return;

                    ranges.sort((a,b) => (a.start - b.start) || (b.end - a.end));
                    const nonOverlapping = [];
                    let lastEnd = -1;
                    for (const rg of ranges) {
                        if (rg.start >= lastEnd) {
                            nonOverlapping.push(rg);
                            lastEnd = rg.end;
                        }
                    }

                    const frag = document.createDocumentFragment();
                    let idx = 0;
                    nonOverlapping.forEach(rg => {
                        if (rg.start > idx) frag.appendChild(document.createTextNode(text.slice(idx, rg.start)));
                        const mark = document.createElement('mark');
                        mark.className = `spam-category-${rg.category}`;
                        mark.setAttribute('data-spam-keyword', rg.keyword);
                        mark.setAttribute('title', `${rg.keyword} (${rg.category})`);
                        mark.textContent = text.slice(rg.start, rg.end);
                        frag.appendChild(mark);
                        idx = rg.end;
                    });
                    if (idx < text.length) frag.appendChild(document.createTextNode(text.slice(idx)));
                    textNode.parentNode.replaceChild(frag, textNode);
                });
            },

            clearSpamMarks(container) {
                container.querySelectorAll('mark').forEach(mark => {
                    const text = document.createTextNode(mark.textContent || '');
                    mark.replaceWith(text);
                });
            },
            
            getDefaultHtml() {
                return `Hello {{name}},<br><br>My name is Rohan from TIGI HR.<br><br>I noticed you're hiring for key AI roles and thought I'd share how leaders like <b>Quest Global, PubMatic, and Shadi.com</b> are accelerating their AI hiring.<br><br>Instead of spending weeks filtering through candidates who only have buzzwords on their resumes, they receive a pre-vetted shortlist of top-tier AI/ML professionals from us in just <b>48-72 hours</b>.<br><br>This allows them to focus their time on what matters: conducting high-quality technical interviews.<br><br>Would you be open to a brief chat about adopting this strategy at {{company_name}}?<br><br>For more details:<br>Our Company Profile: <a href="http://tigihr.com/company_profile" style="color: #3b82f6; text-decoration: underline;">tigihr.com/company_profile</a><br>Our Service Charges: <a href="http://tigihr.com/charges" style="color: #3b82f6; text-decoration: underline;">tigihr.com/charges</a><br><br>Best,<br><br><b>Rohan Patel | +91 7490017176</b><br><b>Business Development Manager</b><br><br><b>TIGI HR SOLUTION PVT. LTD.</b><br><b>Website:</b> <a href="http://www.tigihr.com/" style="color: #3b82f6; text-decoration: underline;">http://www.tigihr.com/</a>`;
            },

            // AI Enhancement Methods
            async optimizeWithAI() {
                const content = this.nodes.htmlInput.value;
                if (!content.trim()) {
                    this.showNotification('Please add some content to optimize', 'warning');
                    return;
                }

                if (!this.aiReady()) return;
                this.showAILoading();
                try {
                    const systemPrompt = localStorage.getItem('system-prompt') || '';
                    const tpl = this.getPromptTemplate('optimize');
                    const fullPrompt = this.renderPrompt(tpl, { systemPrompt, content });
                    
                    const model = this.initGeminiClient('optimize');
                    const result = await model.generateContent(fullPrompt);
                    const text = this.extractAIText(result);
                    if (!text) throw new Error('Invalid response format from AI');
                    this.showAIResponse(text, 'optimize');
                } catch (error) {
                    const errorMsg = error.message?.includes('API') || error.message?.includes('key')
                        ? 'Invalid API key or quota exceeded. Please check your Gemini API key in Settings.'
                        : error.message?.includes('network') || error.message?.includes('fetch')
                        ? 'Network error. Please check your internet connection and try again.'
                        : `Failed to optimize content: ${error.message || 'Unknown error'}`;
                    this.showAIError(errorMsg, error);
                }
            },

            async getAISuggestions() {
                const content = this.nodes.htmlInput.value;
                if (!content.trim()) {
                    this.showNotification('Please add some content to get suggestions', 'warning');
                    return;
                }

                if (!this.aiReady()) return;
                this.showAILoading();
                try {
                    const systemPrompt = localStorage.getItem('system-prompt') || '';
                    const tpl = this.getPromptTemplate('suggest');
                    const fullPrompt = this.renderPrompt(tpl, { systemPrompt, content });
                    
                    const model = this.initGeminiClient('suggest');
                    const result = await model.generateContent(fullPrompt);
                    const text = this.extractAIText(result);
                    if (!text) throw new Error('Invalid response format from AI');
                    this.showAIResponse(text, 'suggest');
                } catch (error) {
                    const errorMsg = error.message?.includes('API') || error.message?.includes('key')
                        ? 'Invalid API key or quota exceeded. Please check your Gemini API key in Settings.'
                        : error.message?.includes('network') || error.message?.includes('fetch')
                        ? 'Network error. Please check your internet connection and try again.'
                        : `Failed to get suggestions: ${error.message || 'Unknown error'}`;
                    this.showAIError(errorMsg, error);
                }
            },

            async adjustTone() {
                const content = this.nodes.htmlInput.value;
                if (!content.trim()) {
                    this.showNotification('Please add some content to adjust tone');
                    return;
                }

                this.showToneModal();
            },
            
            showToneModal() {
                const toneModal = document.getElementById('tone-modal');
                const toneInput = document.getElementById('tone-input');
                toneInput.value = '';
                toneModal.classList.remove('hidden');
                setTimeout(() => toneInput.focus(), 100);
            },
            
            hideToneModal() {
                document.getElementById('tone-modal').classList.add('hidden');
            },
            
            async applyToneAdjustment() {
                const toneInput = document.getElementById('tone-input');
                const tone = toneInput.value.trim();
                
                if (!tone) {
                    this.showNotification('Please enter a tone style', 'warning');
                    toneInput.style.borderColor = 'var(--color-poppy)';
                    const flashDuration = window.EMAIL_EDITOR_CONSTANTS?.BORDER_FLASH_DURATION_MS || 1500;
                    setTimeout(() => {
                        toneInput.style.borderColor = 'var(--color-platinum)';
                    }, flashDuration);
                    return;
                }
                
                this.hideToneModal();
                const content = this.nodes.htmlInput.value;

                if (!this.aiReady()) return;
                this.showAILoading();
                try {
                    const systemPrompt = localStorage.getItem('system-prompt') || '';
                    const tpl = this.getPromptTemplate('tone');
                    const fullPrompt = this.renderPrompt(tpl, { systemPrompt, content, tone });
                    
                    const model = this.initGeminiClient('tone');
                    const result = await model.generateContent(fullPrompt);
                    const text = this.extractAIText(result);
                    if (!text) throw new Error('Invalid response format from AI');
                    this.showAIResponse(text, 'tone');
                } catch (error) {
                    const errorMsg = error.message?.includes('API') || error.message?.includes('key')
                        ? 'Invalid API key or quota exceeded. Please check your Gemini API key in Settings.'
                        : error.message?.includes('network') || error.message?.includes('fetch')
                        ? 'Network error. Please check your internet connection and try again.'
                        : `Failed to adjust tone: ${error.message || 'Unknown error'}`;
                    this.showAIError(errorMsg, error);
                }
            },

            async generateSubject() {
                const content = this.nodes.htmlInput.value;
                if (!content.trim()) {
                    this.showNotification('Please add some content to generate subject lines', 'warning');
                    return;
                }

                if (!this.aiReady()) return;
                this.showAILoading();
                try {
                    const systemPrompt = localStorage.getItem('system-prompt') || '';
                    // Pass raw subject line with variables for AI context
                    const currentSubject = this.nodes.subjectLineInput ? this.nodes.subjectLineInput.value : '';
                    const numSubjects = localStorage.getItem('num-subjects') || '10';
                    const tpl = this.getPromptTemplate('subject');
                    const fullPrompt = this.renderPrompt(tpl, { systemPrompt, content, subjectLine: currentSubject, numSubjects });
                    
                    const model = this.initGeminiClient('subject');
                    const result = await model.generateContent(fullPrompt);
                    const text = this.extractAIText(result);
                    if (!text) throw new Error('Invalid response format from AI');
                    this.showAIResponse(text, 'subject');
                } catch (error) {
                    const errorMsg = error.message?.includes('API') || error.message?.includes('key')
                        ? 'Invalid API key or quota exceeded. Please check your Gemini API key in Settings.'
                        : error.message?.includes('network') || error.message?.includes('fetch')
                        ? 'Network error. Please check your internet connection and try again.'
                        : `Failed to generate subject lines: ${error.message || 'Unknown error'}`;
                    this.showAIError(errorMsg, error);
                }
            },

            showAILoading() {
                document.getElementById('ai-loading').classList.remove('hidden');
                document.getElementById('ai-response').classList.add('hidden');
            },

            showAIResponse(content, type = 'general') {
                const formatters = {
                    optimize: this.formatOptimizeResponse,
                    suggest: this.formatSuggestionsResponse,
                    tone: this.formatToneResponse,
                    subject: this.formatSubjectResponse,
                    replacement: this.formatReplacementResponse,
                    general: this.formatGeneralResponse
                };
                
                const formatter = formatters[type] || formatters.general;
                const formattedHTML = formatter.call(this, content);
                
                document.getElementById('ai-loading').classList.add('hidden');
                document.getElementById('ai-content').innerHTML = formattedHTML;
                document.getElementById('ai-response').classList.remove('hidden');
            },

            showAIError(message, error = null) {
                // Log error for debugging
                if (error) {
                    console.error('AI Error Details:', error);
                }
                
                document.getElementById('ai-loading').classList.add('hidden');
                const errorHtml = `
                    <div class="p-4 rounded-xl border-2" style="background: rgba(223, 41, 53, 0.1); border-color: var(--color-poppy);">
                        <div class="flex items-start">
                            <i class="fas fa-exclamation-circle text-2xl mr-3" style="color: var(--color-poppy);"></i>
                            <div class="flex-1">
                                <h4 class="font-semibold mb-2" style="color: var(--color-poppy);">Error</h4>
                                <p class="text-sm" style="color: var(--color-text);">${message}</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('ai-content').innerHTML = errorHtml;
                document.getElementById('ai-response').classList.remove('hidden');
                this.showNotification(message, 'error');
            },

            // AI Response Formatters
            formatOptimizeResponse(content) {
                const optimizedContent = this.parseMarkdown(content);
                const contentId = 'opt-' + Date.now();
                
                // Store content for copying
                window.aiContentCache = window.aiContentCache || {};
                window.aiContentCache[contentId] = content;
                
                return `
                    <div class="ai-response-optimize">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-green-800 flex items-center">
                                <i class="fas fa-magic mr-2"></i>Optimized Content
                            </h4>
                            <div class="flex gap-2">
                                <button data-action="copy" data-content-id="${contentId}" class="ai-action-btn ai-btn-copy">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                                <button data-action="apply" data-content-id="${contentId}" class="ai-action-btn ai-btn-apply">
                                    <i class="fas fa-check mr-1"></i>Apply to Editor
                                </button>
                            </div>
                        </div>
                        <div class="ai-content-card">
                            ${optimizedContent}
                        </div>
                    </div>
                `;
            },

            formatSuggestionsResponse(content) {
                const sections = this.parseSuggestionsIntoSections(content);
                const contentId = 'sug-' + Date.now();
                window.aiContentCache = window.aiContentCache || {};
                window.aiContentCache[contentId] = content;
                
                return `
                    <div class="ai-response-suggestions">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-blue-800 flex items-center">
                                <i class="fas fa-lightbulb mr-2"></i>AI Suggestions
                            </h4>
                            <button data-action="copy" data-content-id="${contentId}" class="ai-action-btn ai-btn-copy">
                                <i class="fas fa-copy mr-1"></i>Copy All
                            </button>
                        </div>
                        <div class="ai-suggestions-content space-y-4">
                            ${sections.map(section => `
                                <div class="suggestion-section">
                                    <h5 class="text-sm font-semibold text-blue-700 mb-2 flex items-center">
                                        ${this.getSectionIcon(section.title)} ${section.title}
                                    </h5>
                                    <div class="ml-4">
                                        ${this.parseMarkdown(section.content)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            },

            formatToneResponse(content) {
                const adjustedContent = this.parseMarkdown(content);
                const contentId = 'tone-' + Date.now();
                window.aiContentCache = window.aiContentCache || {};
                window.aiContentCache[contentId] = content;
                
                return `
                    <div class="ai-response-tone">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-purple-800 flex items-center">
                                <i class="fas fa-palette mr-2"></i>Tone Adjusted
                            </h4>
                            <div class="flex gap-2">
                                <button data-action="copy" data-content-id="${contentId}" class="ai-action-btn ai-btn-copy">
                                    <i class="fas fa-copy mr-1"></i>Copy
                                </button>
                                <button data-action="apply" data-content-id="${contentId}" class="ai-action-btn ai-btn-apply">
                                    <i class="fas fa-check mr-1"></i>Replace Content
                                </button>
                            </div>
                        </div>
                        <div class="ai-content-card">
                            ${adjustedContent}
                        </div>
                    </div>
                `;
            },

            formatSubjectResponse(content) {
                const subjects = this.parseSubjectLines(content);
                const contentId = 'subj-' + Date.now();
                window.aiContentCache = window.aiContentCache || {};
                window.aiContentCache[contentId] = subjects.join('\n');
                
                return `
                    <div class="ai-response-subjects">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-lg font-semibold text-orange-800 flex items-center">
                                <i class="fas fa-envelope mr-2"></i>Generated Subject Lines
                            </h4>
                            <button data-action="copy" data-content-id="${contentId}" class="ai-action-btn ai-btn-copy">
                                <i class="fas fa-copy mr-1"></i>Copy All
                            </button>
                        </div>
                        <div class="ai-subjects-list">
                            ${subjects.map((subject, index) => {
                                const subjectId = 'subj-' + Date.now() + '-' + index;
                                window.aiContentCache[subjectId] = subject;
                                return `
                                    <div class="ai-subject-card">
                                        <div class="ai-subject-header">
                                            <span class="ai-subject-number">${index + 1}.</span>
                                            <span class="ai-subject-text">${subject}</span>
                                            <span class="ai-subject-meta">
                                                ${subject.length} chars 
                                                <span class="ai-spam-indicator">${this.getSpamIndicator(subject)}</span>
                                            </span>
                                        </div>
                                        <div class="ai-subject-actions">
                                            <button data-action="copy" data-content-id="${subjectId}" class="ai-action-btn ai-btn-copy-small">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                            <button data-action="use" data-content-id="${subjectId}" class="ai-action-btn ai-btn-use">
                                                <i class="fas fa-check mr-1"></i>Use This
                                            </button>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            formatReplacementResponse(content) {
                // Content is expected to be an object: { applied, present, skipped }
                if (typeof content === 'string') {
                    // Fallback for string content
                    return this.formatGeneralResponse(content);
                }
                
                const { applied, present, skipped } = content;
                
                if (applied === 0) {
                    const msg = skipped && skipped.length
                        ? 'No occurrences found to replace. The following were not found in your email.'
                        : 'No occurrences found to replace.';
                    return `
                        <div class="ai-response-general">
                            <div class="ai-content-card">
                                <p class="text-slate-600 mb-3">${msg}</p>
                                ${skipped && skipped.length ? `
                                    <div class="space-y-2">
                                        ${skipped.map(m => `
                                            <div class="p-2 rounded" style="background: rgba(0,0,0,0.05);">
                                                <span class="text-sm text-slate-500">${this.escapeHtml(m.from)}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="ai-response-general">
                        <div class="ai-content-card">
                            <div class="flex items-center mb-4">
                                <i class="fas fa-check-circle text-2xl mr-3" style="color: var(--color-success);"></i>
                                <h3 class="text-lg font-semibold">Applied ${applied} Replacement${applied === 1 ? '' : 's'}</h3>
                            </div>
                            
                            <div class="space-y-3">
                                ${present.map(m => `
                                    <div class="p-3 rounded-lg border-2" style="background: var(--color-light-bg); border-color: var(--color-platinum);">
                                        <div class="flex items-start gap-3">
                                            <div class="flex-1">
                                                <div class="text-sm text-slate-500 mb-1">Original:</div>
                                                <div class="p-2 rounded mb-2" style="background: rgba(223, 41, 53, 0.1); border-left: 3px solid var(--color-poppy);">
                                                    ${this.escapeHtml(m.from)}
                                                </div>
                                                <div class="text-sm text-slate-500 mb-1">Replaced with:</div>
                                                <div class="p-2 rounded" style="background: rgba(232, 144, 5, 0.1); border-left: 3px solid var(--color-success);">
                                                    <strong>${this.escapeHtml(m.to)}</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            ${skipped && skipped.length ? `
                                <div class="mt-4 pt-4 border-t-2" style="border-color: var(--color-platinum);">
                                    <p class="text-sm text-slate-500 mb-2">
                                        <i class="fas fa-info-circle mr-1"></i>
                                        Skipped (not found in email):
                                    </p>
                                    <div class="space-y-1">
                                        ${skipped.map(m => `
                                            <div class="text-sm text-slate-400">${this.escapeHtml(m.from)}</div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            },
            
            formatGeneralResponse(content) {
                const parsedContent = this.parseMarkdown(content);
                return `
                    <div class="ai-response-general">
                        <div class="ai-content-card">
                            ${parsedContent}
                        </div>
                    </div>
                `;
            },

            // Helper Methods for Formatters
            parseMarkdown(text) {
                if (!text) return '';
                
                // Split into lines for better processing
                let lines = text.split('\n');
                let result = [];
                let inList = false;
                let listItems = [];
                
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i].trim();
                    
                    // Skip empty lines
                    if (!line) {
                        if (inList) {
                            result.push('<ul class="list-disc ml-6 mb-3 space-y-1">' + listItems.join('') + '</ul>');
                            listItems = [];
                            inList = false;
                        }
                        continue;
                    }
                    
                    // Headers (###, ##, #)
                    if (line.startsWith('###')) {
                        result.push(`<h4 class="text-md font-semibold text-gray-800 mt-4 mb-2">${line.substring(3).trim()}</h4>`);
                    }
                    else if (line.startsWith('##')) {
                        result.push(`<h3 class="text-lg font-semibold text-gray-800 mt-4 mb-2">${line.substring(2).trim()}</h3>`);
                    }
                    else if (line.startsWith('#')) {
                        result.push(`<h2 class="text-xl font-semibold text-gray-800 mt-4 mb-3">${line.substring(1).trim()}</h2>`);
                    }
                    // Numbered lists
                    else if (/^\d+\./.test(line)) {
                        let content = line.replace(/^\d+\.\s*/, '');
                        listItems.push(`<li class="text-gray-700">${this.formatInlineMarkdown(content)}</li>`);
                        inList = true;
                    }
                    // Bullet lists
                    else if (line.startsWith('- ') || line.startsWith('* ')) {
                        let content = line.substring(2);
                        listItems.push(`<li class="text-gray-700">${this.formatInlineMarkdown(content)}</li>`);
                        inList = true;
                    }
                    // Regular paragraphs
                    else {
                        if (inList) {
                            result.push('<ul class="list-disc ml-6 mb-3 space-y-1">' + listItems.join('') + '</ul>');
                            listItems = [];
                            inList = false;
                        }
                        result.push(`<p class="mb-3 text-gray-700 leading-relaxed">${this.formatInlineMarkdown(line)}</p>`);
                    }
                }
                
                // Close any remaining list
                if (inList) {
                    result.push('<ul class="list-disc ml-6 mb-3 space-y-1">' + listItems.join('') + '</ul>');
                }
                
                return result.join('');
            },

            formatInlineMarkdown(text) {
                return text
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em class="italic">$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 py-0.5 rounded text-sm font-mono">$1</code>');
            },

            parseSubjectLines(text) {
                if (!text) return [];
                
                const lines = text.split('\n').filter(line => line.trim());
                const subjects = [];
                
                lines.forEach(line => {
                    const cleanLine = line.replace(/^\d+\.\s*/, '').replace(/^[-*]\s*/, '').trim();
                    if (cleanLine && cleanLine.length > 5 && cleanLine.length < 100) {
                        subjects.push(cleanLine);
                    }
                });
                
                return subjects;
            },

            getSpamIndicator(subject) {
                const spamWords = ['free', 'urgent', 'limited', 'act now', 'click here', 'winner', 'congratulations'];
                const lowerSubject = subject.toLowerCase();
                const spamCount = spamWords.filter(word => lowerSubject.includes(word)).length;
                
                if (spamCount === 0) return ' Safe';
                if (spamCount === 1) return ' Caution';
                return ' Risky';
            },

            escapeForJS(str) {
                if (!str) return '';
                // Remove HTML tags for JS insertion, keep text only
                const textOnly = str.replace(/<[^>]*>/g, '');
                return textOnly
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/"/g, '\\"')
                    .replace(/\n/g, '\\n')
                    .replace(/\r/g, '\\r');
            },

            // Action Button Handlers
            copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => {
                    this.showNotification('Copied to clipboard!');
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    this.showNotification('Failed to copy to clipboard');
                });
            },

            applyToEditor(content) {
                this.nodes.htmlInput.value = content;
                this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                this.showNotification('Content applied to editor!');
            },

            useSubject(subject) {
                if (this.nodes.subjectLineInput) {
                    // Apply the subject line directly (it should contain variables if needed)
                    this.nodes.subjectLineInput.value = subject;
                    // Update the preview to reflect the new subject line
                    this.renderSubjectLine();
                    this.saveToLocalStorage();
                    this.showNotification('Subject line applied!');
                } else {
                    this.copyToClipboard(subject);
                    this.showNotification('Subject line copied!');
                }
            },

            parseSuggestionsIntoSections(text) {
                // Split content by headers or numbered sections
                const sections = [];
                const lines = text.split('\n');
                let currentSection = { title: 'General Suggestions', content: '' };
                
                lines.forEach(line => {
                    if (line.match(/^#{1,3}\s/)) {
                        if (currentSection.content) sections.push(currentSection);
                        currentSection = { 
                            title: line.replace(/^#{1,3}\s/, '').trim(), 
                            content: '' 
                        };
                    } else if (line.match(/^\d+\.\s*[A-Z]/)) {
                        if (currentSection.content) sections.push(currentSection);
                        currentSection = { 
                            title: line.replace(/^\d+\.\s*/, '').trim().split(':')[0], 
                            content: line 
                        };
                    } else {
                        currentSection.content += line + '\n';
                    }
                });
                
                if (currentSection.content) sections.push(currentSection);
                return sections;
            },

            getSectionIcon(title) {
                const iconMap = {
                    'subject': '',
                    'content': '',
                    'call': '',
                    'action': '',
                    'cta': '',
                    'spam': '',
                    'structure': '',
                    'engagement': '',
                    'tone': ''
                };
                
                const lowerTitle = title.toLowerCase();
                for (const [key, icon] of Object.entries(iconMap)) {
                    if (lowerTitle.includes(key)) return icon;
                }
                return '';
            },

            // Template Management Methods
            saveTemplate() {
                this.showSaveTemplateModal();
            },
            
            showSaveTemplateModal() {
                const modal = document.getElementById('save-template-modal');
                const input = document.getElementById('template-name-input');
                input.value = '';
                modal.classList.remove('hidden');
                setTimeout(() => input.focus(), 100);
            },
            
            hideSaveTemplateModal() {
                document.getElementById('save-template-modal').classList.add('hidden');
            },
            
            confirmSaveTemplate() {
                const input = document.getElementById('template-name-input');
                const templateName = input.value.trim();
                
                // Validate template name
                const validation = window.EmailEditorUtils?.validateTemplateName(templateName) || 
                    { isValid: !!templateName, error: 'Template name cannot be empty' };
                
                if (!validation.isValid) {
                    this.showNotification(validation.error, 'error');
                    input.style.borderColor = 'var(--color-poppy)';
                    const flashDuration = window.EMAIL_EDITOR_CONSTANTS?.BORDER_FLASH_DURATION_MS || 1500;
                    setTimeout(() => {
                        input.style.borderColor = 'var(--color-platinum)';
                    }, flashDuration);
                    return;
                }

                const template = {
                    name: templateName,
                    html: this.nodes.htmlInput.value,
                    subjectLine: this.nodes.subjectLineInput ? this.nodes.subjectLineInput.value : '',
                    variables: Array.from(this.getVariables()),
                    timestamp: new Date().toISOString()
                };

                const savedTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                savedTemplates.push(template);
                localStorage.setItem('emailTemplates', JSON.stringify(savedTemplates));

                this.hideSaveTemplateModal();
                this.showNotification('Template saved successfully!');
                this.updateLastSaved();
            },

            loadTemplate() {
                const savedTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                if (savedTemplates.length === 0) {
                    this.showNotification('No saved templates found', 'warning');
                    return;
                }

                this.showLoadTemplateModal(savedTemplates);
            },
            
            showLoadTemplateModal(templates) {
                const modal = document.getElementById('load-template-modal');
                const templateList = document.getElementById('template-list');
                
                templateList.innerHTML = '';
                templates.forEach(template => {
                    const item = document.createElement('div');
                    item.className = 'template-item';
                    item.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-grow">
                                <div class="font-semibold" style="color: var(--color-text);">${this.constructor.escapeHtml(template.name)}</div>
                                <div class="text-xs mt-1" style="color: var(--color-text-muted);">
                                    <i class="fas fa-clock mr-1"></i>${new Date(template.timestamp).toLocaleString()}
                                </div>
                            </div>
                            <i class="fas fa-chevron-right" style="color: var(--color-blue-violet);"></i>
                        </div>
                    `;
                    item.addEventListener('click', () => this.loadTemplateByName(template.name));
                    templateList.appendChild(item);
                });
                
                modal.classList.remove('hidden');
            },
            
            hideLoadTemplateModal() {
                document.getElementById('load-template-modal').classList.add('hidden');
            },
            
            loadTemplateByName(templateName) {
                const savedTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                const template = savedTemplates.find(t => t.name === templateName);
                
                if (!template) {
                    this.showNotification('Template not found', 'error');
                    return;
                }

                this.nodes.htmlInput.value = template.html;
                if (template.subjectLine && this.nodes.subjectLineInput) {
                    this.nodes.subjectLineInput.value = template.subjectLine;
                }
                this.nodes.variablesContainer.innerHTML = '';
                
                template.variables.forEach(([name, value]) => {
                    this.addVariableRow(name, value);
                });

                this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                this.hideLoadTemplateModal();
                this.showNotification('Template loaded successfully!');
            },

            clearAll() {
                if (confirm('Are you sure you want to clear all content and variables?')) {
                    this.nodes.htmlInput.value = '';
                    this.nodes.variablesContainer.innerHTML = '';
                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                    this.showNotification('All content cleared');
                }
            },

            // Auto-save functionality
            initAutoSave() {
                const AUTO_SAVE_INTERVAL = window.EMAIL_EDITOR_CONSTANTS?.AUTO_SAVE_INTERVAL_MS || 30000;
                this.autoSaveInterval = setInterval(() => {
                    this.saveToLocalStorage();
                }, AUTO_SAVE_INTERVAL);

                // Save on page unload
                this.beforeUnloadHandler = () => {
                    this.saveToLocalStorage();
                };
                window.addEventListener('beforeunload', this.beforeUnloadHandler);
            },
            
            // Cleanup function to prevent memory leaks
            cleanup() {
                // Clear auto-save interval
                if (this.autoSaveInterval) {
                    clearInterval(this.autoSaveInterval);
                    this.autoSaveInterval = null;
                }
                
                // Remove event listener
                if (this.beforeUnloadHandler) {
                    window.removeEventListener('beforeunload', this.beforeUnloadHandler);
                    this.beforeUnloadHandler = null;
                }
                
                // Clear AI content cache
                if (window.aiContentCache) {
                    window.aiContentCache = null;
                }
            },

            saveToLocalStorage() {
                const data = {
                    html: this.nodes.htmlInput.value,
                    subjectLine: this.nodes.subjectLineInput ? this.nodes.subjectLineInput.value : '',
                    variables: Array.from(this.getVariables()),
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('emailEditorData', JSON.stringify(data));
                this.updateLastSaved();
            },

            loadFromLocalStorage() {
                // Initialize default system prompt if none exists
                if (!localStorage.getItem('system-prompt')) {
                    const defaultSystemPrompt = `You are an expert email marketing specialist and copywriter with a deep understanding of conversion-focused principles. Your analysis and recommendations are grounded in established frameworks like AIDA (Attention, Interest, Desire, Action) and PAS (Problem, Agitate, Solution).

Your responses must always be:
- **Expert-Level:** Provide insights that a seasoned professional would.
- **Actionable:** Give clear, direct advice that the user can implement immediately.
- **Concise:** Be brief and to the point. Avoid filler and unnecessary explanations.
- **Data-Driven:** Focus on changes that demonstrably improve open rates, click-through rates, and deliverability while avoiding spam filters.`;
                    localStorage.setItem('system-prompt', defaultSystemPrompt);
                }

                const data = JSON.parse(localStorage.getItem('emailEditorData') || 'null');
                if (data && data.html) {
                    this.nodes.htmlInput.value = data.html;
                    if (data.subjectLine && this.nodes.subjectLineInput) {
                        this.nodes.subjectLineInput.value = data.subjectLine;
                    }
                    this.nodes.variablesContainer.innerHTML = '';
                    
                    data.variables.forEach(([name, value]) => {
                        this.addVariableRow(name, value);
                    });

                    this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                    this.showNotification('Previous work restored');
                }

                // If arriving from templates.html with a selection, load by name
                const toLoad = localStorage.getItem('template-to-load');
                if (toLoad) {
                    localStorage.removeItem('template-to-load');
                    try {
                        const savedTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '[]');
                        const t = savedTemplates.find(x => x && x.name === toLoad);
                        if (t) {
                            this.nodes.htmlInput.value = t.html || '';
                            this.nodes.variablesContainer.innerHTML = '';
                            (t.variables || []).forEach(([name, value]) => this.addVariableRow(name, value));
                            this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                            this.showNotification(`Loaded template: ${toLoad}`);
                        }
                    } catch(_) {}
                }
            },

            updateLastSaved() {
                const now = new Date();
                document.getElementById('last-saved').textContent = 
                    `Last saved: ${now.toLocaleTimeString()}`;
            },

            updateWordCount() {
                const content = this.nodes.htmlInput.value;
                const words = content.trim() ? (content.match(/\S+/g) || []).length : 0;
                const chars = content.length;
                
                document.getElementById('word-count').textContent = `Words: ${words}`;
                document.getElementById('char-count').textContent = `Characters: ${chars}`;
            },

            showNotification(message, type = 'success') {
                // Use shared utility if available
                if (window.EmailEditorUtils?.showNotification) {
                    window.EmailEditorUtils.showNotification(message, type);
                    return;
                }
                
                // Fallback to original implementation
                const feedback = this.nodes.copyFeedback || document.getElementById('copy-feedback');
                if (feedback) {
                    feedback.textContent = message;
                    feedback.classList.remove('opacity-0');
                    const duration = window.EMAIL_EDITOR_CONSTANTS?.COPY_FEEDBACK_DURATION_MS || 2000;
                    setTimeout(() => feedback.classList.add('opacity-0'), duration);
                }
            },

            // Keyboard shortcuts
            initKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key.toLowerCase()) {
                            case 's':
                                e.preventDefault();
                                this.saveTemplate();
                                break;
                            case 'z':
                                if (e.shiftKey) {
                                    e.preventDefault();
                                    this.redo();
                                } else {
                                    e.preventDefault();
                                    this.undo();
                                }
                                break;
                            case 'y':
                                e.preventDefault();
                                this.redo();
                                break;
                            case 'o':
                                e.preventDefault();
                                this.optimizeWithAI();
                                break;
                            case 'shift':
                                if (e.key === 'c' || e.key === 'C') {
                                    e.preventDefault();
                                    this.copyHtmlToClipboard();
                                }
                                break;
                        }
                    }
                });
            },

            undo() {
                document.execCommand('undo');
            },

            redo() {
                document.execCommand('redo');
            },

            // Initialize help modal
            initHelpModal() {
                const helpBtn = document.getElementById('help-btn');
                const helpModal = document.getElementById('help-modal');
                const closeHelp = document.getElementById('close-help');

                helpBtn.addEventListener('click', () => {
                    helpModal.classList.remove('hidden');
                });

                closeHelp.addEventListener('click', () => {
                    helpModal.classList.add('hidden');
                });

                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        helpModal.classList.add('hidden');
                    }
                });
            },

            // Load custom spam words from settings
            loadCustomSpamWords() {
                const customWords = JSON.parse(localStorage.getItem('custom-spam-words') || '[]');
                if (customWords.length > 0 && window.spamKeywords) {
                    // Add custom words to the global spam keywords
                    customWords.forEach(word => {
                        const regex = new RegExp(word.highlight || `\\b${word.keyword}\\b`, 'gi');
                        window.spamKeywords.push({
                            highlight: regex,
                            keyword: word.keyword,
                            category: word.category
                        });
                    });
                    // Re-initialize the highlighter if it exists
                    if (this.nodes.htmlInput && typeof $.fn.highlightWithinTextarea === 'function') {
                        $(this.nodes.htmlInput).highlightWithinTextarea('destroy');
                        $(this.nodes.htmlInput).highlightWithinTextarea({ highlight: window.spamKeywords });
                    }
                }
            },

            // Insert signature at cursor position
            insertSignature() {
                const signature = localStorage.getItem('email-signature');
                if (!signature) {
                    this.showNotification('No signature found in settings');
                    return;
                }
                
                const currentContent = this.nodes.htmlInput.value;
                // Insert signature at the end with line breaks
                this.nodes.htmlInput.value = currentContent + (currentContent ? '<br><br>' : '') + signature;
                this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                this.showNotification('Signature inserted successfully!');
            }
        };

        // Extend EmailEditor with Spam Rewrite capability
        EmailEditor.rewriteSpamWords = async function() {
            const content = this.nodes.htmlInput.value;
            if (!content.trim()) { this.showNotification('Please add some content first'); return; }

            // Ensure preview is rendered and highlighted to collect current spam words
            this.renderPreview();
            const detected = this.collectCurrentSpamKeywords();
            const defaultList = detected.slice(0, 30).join(', ');
            this.showSpamRewriteModal(defaultList);
        };
        
        EmailEditor.showSpamRewriteModal = function(defaultWords) {
            const modal = document.getElementById('spam-rewrite-modal');
            const input = document.getElementById('spam-words-input');
            input.value = defaultWords;
            modal.classList.remove('hidden');
            setTimeout(() => input.focus(), 100);
        };
        
        EmailEditor.hideSpamRewriteModal = function() {
            document.getElementById('spam-rewrite-modal').classList.add('hidden');
        };
        
        EmailEditor.confirmSpamRewrite = async function() {
            const input = document.getElementById('spam-words-input');
            const userList = input.value.trim();
            const terms = (userList || '').split(',').map(s => s.trim()).filter(Boolean);
            
            if (terms.length === 0) { 
                this.showNotification('No terms provided'); 
                return; 
            }
            
            this.hideSpamRewriteModal();
            const content = this.nodes.htmlInput.value;

            if (!this.aiReady()) return;
            this.showAILoading();
            try {
                const systemPrompt = localStorage.getItem('system-prompt') || '';
                const tpl = this.getPromptTemplate('rewrite');
                const fullPrompt = this.renderPrompt(tpl, { systemPrompt, content, terms: JSON.stringify(terms) });
                
                const model = this.initGeminiClient('rewrite');
                const result = await model.generateContent(fullPrompt);
                const text = this.extractAIText(result) || '';
                const mapping = this.parseReplacementMapping(text);
                if (!Array.isArray(mapping) || mapping.length === 0) {
                    throw new Error('No valid replacements returned');
                }

                // Filter mappings to only those that actually appear in the current preview (text) OR source (HTML)
                const previewText = (this.nodes.emailPreview.textContent || '');
                const sourceHtml = (this.nodes.htmlInput.value || '');
                const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const toFlexibleSpace = (s) => s.replace(/\s+/g, '\\s+');
                const toQuoteVariants = (s) => [s, s.replace(/'/g, ''), s.replace(//g, "'")];
                const appearsInPreview = (term) => {
                    for (const variant of toQuoteVariants(term)) {
                        const re = new RegExp(toFlexibleSpace(escapeRegex(variant)), 'i');
                        if (re.test(previewText) || re.test(sourceHtml)) return true;
                    }
                    return false;
                };

                const present = mapping.filter(m => m && typeof m.from === 'string' && appearsInPreview(m.from));
                const skipped = mapping.filter(m => m && typeof m.from === 'string' && !appearsInPreview(m.from));

                let applied = present.length ? this.applyReplacementsToPreview(present) : 0;
                if (applied === 0) {
                    // Final fallback: attempt replacements directly on source HTML (DOM-walk to avoid attributes)
                    const appliedToSource = this.applyReplacementsToSourceHtml(mapping);
                    if (appliedToSource > 0) {
                        // Source updated; trigger input pipeline to re-render preview/highlights
                        this.nodes.htmlInput.dispatchEvent(new Event('input', { bubbles: true }));
                        applied = appliedToSource;
                    }
                }
                
                // Sync preview -> source and re-highlight if any applied
                if (applied > 0) {
                    this.updateSourceFromPreview();
                }
                
                // Show formatted replacement response
                this.showAIResponse({
                    applied: applied,
                    present: present,
                    skipped: skipped
                }, 'replacement');
                
                if (applied > 0) {
                    this.showNotification('Spam words rewritten successfully');
                }
            } catch (error) {
                const errorMsg = error.message?.includes('API') || error.message?.includes('key')
                    ? 'Invalid API key or quota exceeded. Please check your Gemini API key in Settings.'
                    : error.message?.includes('network') || error.message?.includes('fetch')
                    ? 'Network error. Please check your internet connection and try again.'
                    : `Failed to rewrite spam words: ${error.message || 'Unknown error'}. Try with fewer terms.`;
                this.showAIError(errorMsg, error);
            }
        };

        EmailEditor.collectCurrentSpamKeywords = function() {
            const set = new Set();
            // marks exist only in preview; ensure latest
            // Collect the actual matched text content, not the keyword label
            this.nodes.emailPreview.querySelectorAll('mark[data-spam-keyword]').forEach(m => {
                const actualText = (m.textContent || '').trim();
                if (actualText) set.add(actualText);
            });
            return Array.from(set);
        };

        EmailEditor.parseReplacementMapping = function(text) {
            if (!text) return [];
            try {
                // strip fences if present
                const cleaned = text.replace(/```[\s\S]*?\n?/g, '').trim();
                const jsonStart = cleaned.indexOf('[');
                const jsonEnd = cleaned.lastIndexOf(']');
                if (jsonStart !== -1 && jsonEnd !== -1) {
                    const arr = JSON.parse(cleaned.slice(jsonStart, jsonEnd + 1));
                    return (Array.isArray(arr) ? arr : []).filter(x => x && typeof x.from === 'string' && typeof x.to === 'string');
                }
            } catch(_) {}
            // fallback: line format "from -> to"
            const lines = text.split(/\r?\n/);
            const pairs = [];
            lines.forEach(line => {
                const m = line.match(/^(.+?)\s*->\s*(.+)$/);
                if (m) pairs.push({ from: m[1].trim(), to: m[2].trim() });
            });
            return pairs;
        };

        EmailEditor.applyReplacementsToPreview = function(mapping) {
            // Remove marks to avoid replacing inside <mark>
            this.clearSpamMarks(this.nodes.emailPreview);

            const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const toQuoteVariants = (s) => [
                s,
                s.replace(/'/g, '\u2019'),
                s.replace(/'/g, "'")
            ];
            const toFlexibleSpace = (s) => s.replace(/\s+/g, '\\s+');
            const isWordLike = (s) => /^(?:[\p{L}\p{N}_]+)$/u.test(s);
            
            let count = 0;
            
            // Strategy 1: Try whole innerHTML replacement for multi-node phrases
            let innerHTML = this.nodes.emailPreview.innerHTML;
            const originalInnerHTML = innerHTML;
            
            mapping.forEach(({ from, to }) => {
                if (!from || typeof to !== 'string') return;
                
                const candidates = toQuoteVariants(from);
                let replacedInHTML = false;
                
                for (const candidate of candidates) {
                    if (isWordLike(candidate)) {
                        // Single word: use word boundaries
                        const pat = new RegExp(`\\b${escapeRegex(candidate)}\\b`, 'gi');
                        const matches = innerHTML.match(pat);
                        if (matches) {
                            innerHTML = innerHTML.replace(pat, to);
                            count += matches.length;
                            replacedInHTML = true;
                            break;
                        }
                    } else {
                        // Phrase: flexible whitespace, handles multiple nodes
                        const pat = new RegExp(toFlexibleSpace(escapeRegex(candidate)), 'gi');
                        const matches = innerHTML.match(pat);
                        if (matches) {
                            innerHTML = innerHTML.replace(pat, to);
                            count += matches.length;
                            replacedInHTML = true;
                            break;
                        }
                    }
                }
                
                // Fallback: case-insensitive literal match
                if (!replacedInHTML) {
                    const fallback = new RegExp(escapeRegex(from), 'gi');
                    const matches = innerHTML.match(fallback);
                    if (matches) {
                        innerHTML = innerHTML.replace(fallback, to);
                        count += matches.length;
                    }
                }
            });
            
            // Apply the updated HTML if changes were made
            if (innerHTML !== originalInnerHTML) {
                this.nodes.emailPreview.innerHTML = innerHTML;
            } else {
                // Strategy 2: Fallback to node-by-node replacement for edge cases
                const walker = document.createTreeWalker(this.nodes.emailPreview, NodeFilter.SHOW_TEXT, {
                    acceptNode: (node) => {
                        if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                        const parent = node.parentElement;
                        if (!parent) return NodeFilter.FILTER_REJECT;
                        const tag = parent.tagName;
                        if (tag === 'SCRIPT' || tag === 'STYLE') return NodeFilter.FILTER_REJECT;
                        return NodeFilter.FILTER_ACCEPT;
                    }
                });
                const nodes = [];
                let n;
                while ((n = walker.nextNode())) nodes.push(n);

                nodes.forEach(node => {
                    let text = node.nodeValue;
                    mapping.forEach(({ from, to }) => {
                        if (!from || typeof to !== 'string') return;
                        const candidates = toQuoteVariants(from);
                        let replacedThisTerm = false;
                        for (const candidate of candidates) {
                            const beforeCandidate = text;
                            if (isWordLike(candidate)) {
                                const pat = new RegExp(`\\b${escapeRegex(candidate)}\\b`, 'gi');
                                text = text.replace(pat, () => { count++; replacedThisTerm = true; return to; });
                            } else {
                                const pat = new RegExp(toFlexibleSpace(escapeRegex(candidate)), 'gi');
                                text = text.replace(pat, () => { count++; replacedThisTerm = true; return to; });
                            }
                            if (text !== beforeCandidate) break;
                        }
                        if (!replacedThisTerm) {
                            const fallback = new RegExp(escapeRegex(from), 'gi');
                            text = text.replace(fallback, () => { count++; return to; });
                        }
                    });
                    node.nodeValue = text;
                });
            }

            // Re-apply spam highlights post-change
            this.highlightSpamInPreview();
            return count;
        };

        // Apply replacements by parsing source HTML and updating only text nodes
        EmailEditor.applyReplacementsToSourceHtml = function(mapping) {
            const html = this.nodes.htmlInput.value || '';
            if (!html || !Array.isArray(mapping) || mapping.length === 0) return 0;

            const escapeRegex = (s) => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const toQuoteVariants = (s) => [
                s,
                s.replace(/'/g, '\u2019'),
                s.replace(/'/g, "'")
            ];
            const toFlexibleSpace = (s) => s.replace(/\s+/g, '\\s+');
            const isWordLike = (s) => /^(?:[\p{L}\p{N}_]+)$/u.test(s);

            let count = 0;
            
            // Strategy 1: Try direct HTML string replacement for phrases
            let updatedHTML = html;
            const originalHTML = html;
            
            mapping.forEach(({ from, to }) => {
                if (!from || typeof to !== 'string') return;
                
                const candidates = toQuoteVariants(from);
                let replacedInHTML = false;
                
                for (const candidate of candidates) {
                    if (isWordLike(candidate)) {
                        // Single word: use word boundaries
                        const pat = new RegExp(`\\b${escapeRegex(candidate)}\\b`, 'gi');
                        const matches = updatedHTML.match(pat);
                        if (matches) {
                            updatedHTML = updatedHTML.replace(pat, to);
                            count += matches.length;
                            replacedInHTML = true;
                            break;
                        }
                    } else {
                        // Phrase: flexible whitespace
                        const pat = new RegExp(toFlexibleSpace(escapeRegex(candidate)), 'gi');
                        const matches = updatedHTML.match(pat);
                        if (matches) {
                            updatedHTML = updatedHTML.replace(pat, to);
                            count += matches.length;
                            replacedInHTML = true;
                            break;
                        }
                    }
                }
                
                // Fallback: case-insensitive literal match
                if (!replacedInHTML) {
                    const fallback = new RegExp(escapeRegex(from), 'gi');
                    const matches = updatedHTML.match(fallback);
                    if (matches) {
                        updatedHTML = updatedHTML.replace(fallback, to);
                        count += matches.length;
                    }
                }
            });
            
            if (updatedHTML !== originalHTML) {
                this.nodes.htmlInput.value = updatedHTML;
                return count;
            }
            
            // Strategy 2: Fallback to DOM-based replacement
            const container = document.createElement('div');
            container.innerHTML = html;

            const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT, {
                acceptNode: (node) => {
                    if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
                    const parent = node.parentElement;
                    if (!parent) return NodeFilter.FILTER_REJECT;
                    const tag = parent.tagName;
                    if (tag === 'SCRIPT' || tag === 'STYLE') return NodeFilter.FILTER_REJECT;
                    return NodeFilter.FILTER_ACCEPT;
                }
            });
            const nodes = [];
            let n;
            while ((n = walker.nextNode())) nodes.push(n);

            nodes.forEach(node => {
                let text = node.nodeValue;
                mapping.forEach(({ from, to }) => {
                    if (!from || typeof to !== 'string') return;
                    const candidates = toQuoteVariants(from);
                    let replacedThisTerm = false;
                    for (const candidate of candidates) {
                        const beforeCandidate = text;
                        if (isWordLike(candidate)) {
                            const pat = new RegExp(`\\b${escapeRegex(candidate)}\\b`, 'gi');
                            text = text.replace(pat, () => { count++; replacedThisTerm = true; return to; });
                        } else {
                            const pat = new RegExp(toFlexibleSpace(escapeRegex(candidate)), 'gi');
                            text = text.replace(pat, () => { count++; replacedThisTerm = true; return to; });
                        }
                        if (text !== beforeCandidate) break;
                    }
                    if (!replacedThisTerm) {
                        const fallback = new RegExp(escapeRegex(from), 'gi');
                        text = text.replace(fallback, () => { count++; return to; });
                    }
                });
                node.nodeValue = text;
            });

            if (count > 0) {
                this.nodes.htmlInput.value = container.innerHTML;
            }
            return count;
        };

        EmailEditor.escapeHtml = function(s) {
            return String(s).replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
        };

        EmailEditor.init();
    });
    </script>
</body>
</html>